<!DOCTYPE html>
<html lang="en">
<head>
  <base href="<?= ScriptApp.getService().getUrl() ?>" target="_top">
  <title>Search Ticket Status - Yngen Group IT Ticketing System</title>
  <!-- Bootstrap 5 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
  <!-- Bootstrap Icons CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8f9fa;
    }
    .container {
      margin-top: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .card-custom {
      background-color: #fff;
      border-radius: 5px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .form-label { font-weight: 600; }
    .hidden { display: none !important; }
    .table-responsive {
      margin-top: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }
    table { font-size: 1rem; }
    th.action-col, td.action-col { text-align: center; vertical-align: middle; width: 100px; }
    .pagination-container { display: flex; justify-content: center; margin-top: 20px; }
    .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 12000; }
    .toast { cursor: pointer; margin: 0; }
    .toast:hover { box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    .toast.bg-success { background-color: #28a745 !important; }
    .toast.bg-danger  { background-color: #dc3545 !important; }
  </style>
  <style>
    /* Sidebar from index.html */
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #f5f7fa;
      color: #212529;
    }
    .sidebar {
      position: fixed; top: 0; left: 0;
      width: 60px; height: 100vh;
      background: #343a40;
      overflow-x: hidden;
      transition: width 0.3s;
      z-index: 1000;
    }
    .sidebar:hover { width: 200px; }
    .sidebar .logo {
      text-align: center;
      padding: 16px 0;
    }
    .sidebar .logo img { max-width: 32px; }
    .sidebar nav {
      display: flex; flex-direction: column;
    }
    .sidebar .nav-link {
      display: flex; align-items: center;
      color: #fff; padding: 12px 16px;
      text-decoration: none; white-space: nowrap;
      transition: background 0.2s;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      background: #495057;
    }
    .sidebar .nav-link i {
      font-size: 1.5rem;
      width: 24px;
      margin-right: 12px;
    }
    .sidebar .nav-link span {
      opacity: 0;
      transition: opacity 0.3s;
    }
    .sidebar:hover .nav-link span {
      opacity: 1;
    }
    .sidebar .divider {
      border-top:1px solid #495057;
      margin:8px auto;
      width:60%;
    }
    .content {
      margin-left: 60px;
      transition: margin-left 0.3s;
      padding: 20px 40px;
      background: #f8f9fa;
    }
    .sidebar:hover + .content {
      margin-left: 200px;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <img
        src="https://res.cloudinary.com/dbi3vgnnj/image/upload/v1746686322/YDC_Logo_1_orjbaj.png"
        alt="YNGEN"
      />
    </div>
    <nav>
      <a class="nav-link" href="?page=index">
        <i class="fa fa-pie-chart"></i><span>Dashboard</span>
      </a>
      <a class="nav-link" href="?page=createTicket">
        <i class="fa-solid fa-ticket"></i><span>Create Ticket</span>
      </a>
      <a class="nav-link active" href="?page=searchStatus">
        <i class="fa-solid fa-magnifying-glass"></i><span>Search Status</span>
      </a>
      <a class="nav-link" href="?page=ithub">
        <i class="fa-solid fa-circle-info"></i><span>IT How-To Hub</span>
      </a>
      <div class="divider"></div>
      <a class="nav-link" href="?page=updateStatus">
        <i class="fa-solid fa-pen-to-square"></i><span>Update Ticket</span>
      </a>
    </nav>
  </div>

  <!-- Main content -->
  <div class="content">
    <div class="container">
      <div class="row">
        <div class="col-md-8 offset-md-2">
          <div class="card-custom">
            <h2 class="mb-4">Search Ticket Status</h2>
            <form id="searchForm" class="d-flex mb-4 align-items-center">
              <div class="input-group me-2">
                <input
                  type="password"
                  class="form-control"
                  id="searchEmployeeId"
                  placeholder="Enter your Unique Code (EmpID+MMMDD+SSS-last3)"
                  required
                />
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  id="toggleSearch"
                  tabindex="-1"
                >
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              <button type="submit" class="btn btn-primary d-flex align-items-center" id="searchButton">
                <span id="searchButtonText">Search</span>
                <span id="searchSpinner" class="spinner-border spinner-border-sm text-light ms-2 hidden"></span>
              </button>
            </form>
            <div class="row mb-4">
              <div class="col-auto"><label for="rowsPerPageSelect" class="form-label">Tickets per page:</label></div>
              <div class="col-auto">
                <select id="rowsPerPageSelect" class="form-select" style="width:auto;">
                  <option value="5">5</option>
                  <option value="10" selected>10</option>
                  <option value="20">20</option>
                  <option value="50">50</option>
                  <option value="all">All</option>
                </select>
              </div>
            </div>

            <div id="ticketResults" class="table-responsive"></div>
            <div id="paginationControls" class="pagination-container"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ticket Details Modal -->
  <div class="modal fade" id="ticketDetailsModal" tabindex="-1" aria-labelledby="ticketDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ticketDetailsModalLabel">Ticket Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="ticketDetailsBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reopen Reason Modal -->
  <div class="modal fade" id="reopenModal" tabindex="-1" aria-labelledby="reopenModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reopenModalLabel">Reopen Ticket</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="reopenReason" class="form-label">Reason for Reopening:</label>
            <textarea class="form-control" id="reopenReason" rows="3" placeholder="Enter your reason here..." required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button
            type="button"
            class="btn btn-primary d-flex align-items-center"
            id="submitReopen"
          >
            <span id="submitReopenText">Submit</span>
            <span
              id="submitReopenSpinner"
              class="spinner-border spinner-border-sm text-light ms-2 hidden"
              role="status"
              aria-hidden="true">
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div class="toast-container"></div>
  <div id="ticketToastTemplate" class="toast align-items-center text-white bg-success border-0 hidden"
       role="alert" aria-live="assertive" aria-atomic="true"
       data-bs-autohide="true" data-bs-delay="10000">
    <div class="d-flex">
      <div class="toast-body">
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        <span class="toast-message"></span>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>

  <!-- Error Modal -->
  <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="errorModalLabel">Error</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="errorModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
      document.addEventListener('DOMContentLoaded', () => {
      const inp    = document.getElementById('searchEmployeeId');
      const toggle = document.getElementById('toggleSearch');

      // always uppercase
      inp.addEventListener('input', () => {
        inp.value = inp.value.toUpperCase();
      });

      // eye-icon toggle
      toggle.addEventListener('click', () => {
        const icon = toggle.querySelector('i');
        if (inp.type === 'password') {
          inp.type = 'text';
          icon.classList.replace('bi-eye', 'bi-eye-slash');
        } else {
          inp.type = 'password';
          icon.classList.replace('bi-eye-slash', 'bi-eye');
        }
      });

      // re-init any tooltips if you’ve got them
      document.querySelectorAll('[data-bs-toggle="tooltip"]')
        .forEach(el => new bootstrap.Tooltip(el));
    });
    let headers = [], dataRows = [];
    let currentPage = 1, rowsPerPage = 10, totalPages = 1, ticketToReopen = null;

    function showToast(msg, isError = false) {
      const container = document.querySelector('.toast-container');
      const template = document.getElementById('ticketToastTemplate');
      const toastEl = template.cloneNode(true);
      toastEl.id = '';
      toastEl.classList.remove('hidden');
      toastEl.classList.toggle('bg-danger', isError);
      toastEl.classList.toggle('bg-success', !isError);
      toastEl.querySelector('.toast-message').textContent = msg;
      container.appendChild(toastEl);
      const bsToast = new bootstrap.Toast(toastEl);
      bsToast.show();
      toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }

    document.getElementById('searchEmployeeId').addEventListener('input', function() {
      this.value = this.value.toUpperCase();
    });
    document.getElementById('rowsPerPageSelect').addEventListener('change', function() {
      rowsPerPage = this.value === 'all' ? 'all' : parseInt(this.value);
      currentPage = 1;
      displayTickets();
    });

    document.getElementById('searchForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const btn     = document.getElementById('searchButton');
      const spinner = document.getElementById('searchSpinner');
      btn.disabled   = true;
      spinner.classList.remove('hidden');

      const rawCode = document.getElementById('searchEmployeeId').value.trim().toUpperCase();
      if (!rawCode) {
        showError('Please enter your Employee Code.');
        btn.disabled = false;
        spinner.classList.add('hidden');
        return;
      }

      // 1) Verify the combined code → returns {id, name, lob} or null
      google.script.run
        .withSuccessHandler(emp => {
          if (!emp) {
            // invalid code → same style as createTicket
            showError(
              '<b>We couldn’t verify your Unique Code.</b><br>' +
              'Your Unique Code is your Employee ID + your birth date (MMMDD) + the last three digits of your SSS. Please double-check this combination and try again.'
            );
            btn.disabled = false;
            spinner.classList.add('hidden');
            return;
          }

          // 2) code is good → actually search by emp.id
          google.script.run
            .withSuccessHandler(res => {
              headers  = res.headers;
              dataRows = res.data;

              // sort newest first
              dataRows.sort((a,b) => {
                return parseInt(b[0].slice(4)) - parseInt(a[0].slice(4));
              });

              currentPage = 1;
              displayTickets(emp.id);
              btn.disabled = false;
              spinner.classList.add('hidden');
            })
            .withFailureHandler(err => {
              showError('Error searching tickets: ' + (err.message||err));
              btn.disabled = false;
              spinner.classList.add('hidden');
            })
            .searchTickets(emp.id);

        })
        .withFailureHandler(err => {
          showError('Error verifying code: ' + (err.message||err));
          btn.disabled = false;
          spinner.classList.add('hidden');
        })
        .verifyEmployeeByCode(rawCode);
    });


    function displayTickets(empId = '') {
      const container = document.getElementById('ticketResults');
      const pagination = document.getElementById('paginationControls');
      if (!dataRows.length) {
        container.innerHTML = empId ? `<h3>Tickets for ${empId}</h3>` : '';
        container.innerHTML += '<div class="alert alert-info">No tickets found.</div>';
        showToast(`No tickets found for ${empId}`, true);
        pagination.innerHTML = '';
        return;
      }

      const displayColumns = [
        { header: 'Request Number', index: 0 },
        { header: 'Status', index: 15 },
        { header: 'Timestamp', index: 1 },
        { header: 'Employee ID', index: 2 },
        { header: 'Ticket Category', index: 7 }
      ];

      const cols = displayColumns.filter(col =>
        dataRows.some(row => row[col.index] && row[col.index].toString().trim())
      );

      let rows = [...dataRows];
      if (rowsPerPage !== 'all') {
        totalPages = Math.ceil(rows.length / rowsPerPage);
        const start = (currentPage - 1) * rowsPerPage;
        rows = rows.slice(start, start + rowsPerPage);
      } else {
        totalPages = 1;
      }

      let html = empId ? `<h3>Tickets for ${empId}</h3>` : '';
      html += '<table class="table table-bordered table-striped"><thead><tr>';
      cols.forEach(c => html += `<th>${c.header}</th>`);
      html += '<th>Action</th></tr></thead><tbody>';

      rows.forEach((row, i) => {
        html += '<tr>';
        cols.forEach(c => {
          let cell = row[c.index] || '';
          if (c.index === 1 && cell) cell = new Date(cell).toLocaleString();
          if (c.index === 0 && cell) {
            const realIndex = (rowsPerPage === 'all') ? i : (currentPage - 1) * rowsPerPage + i;
            cell = `<a href="#" onclick="showDetails(${realIndex});return false;">${cell}</a>`;
          }
          html += `<td>${cell}</td>`;
        });
        const status = (row[15] || '').toString().toUpperCase().trim();
        const timestampDate = row[1] ? new Date(row[1]) : null;
        const daysSince = timestampDate
          ? (Date.now() - timestampDate.getTime()) / (1000*60*60*24)
          : Infinity;
        // only disable if not completed or too old
        const disableReopen = status !== 'COMPLETED' || daysSince > 30;
        if (!disableReopen) {
          html += `<td class="action-col">
                     <button class="btn btn-sm btn-primary" onclick="openReopen('${row[0]}')">
                       Reopen
                     </button>
                   </td>`;
        } else {
          html += `<td class="action-col">
                     <button class="btn btn-sm btn-secondary" disabled>
                       Reopen
                     </button>
                   </td>`;
        }
        html += '</tr>';
      });

      html += '</tbody></table>';
      container.innerHTML = html;
      renderPagination();
    }

    function renderPagination() {
      const pagination = document.getElementById('paginationControls');
      if (totalPages <= 1) { pagination.innerHTML = ''; return; }
      let html = '<nav><ul class="pagination">';
      html += `<li class="page-item${currentPage === 1 ? ' disabled' : ''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage - 1});return false;">Previous</a></li>`;
      for (let i = 1; i <= totalPages; i++) html += `<li class="page-item${i === currentPage ? ' active' : ''}"><a class="page-link" href="#" onclick="gotoPage(${i});return false;">${i}</a></li>`;
      html += `<li class="page-item${currentPage === totalPages ? ' disabled' : ''}"><a class="page-link" href="#" onclick="gotoPage(${currentPage + 1});return false;">Next</a></li>`;
      html += '</ul></nav>';
      pagination.innerHTML = html;
    }

    function gotoPage(p) { currentPage = Math.max(1, Math.min(p, totalPages)); displayTickets(); }

    function showDetails(idx) {
    const row = dataRows[idx];
    let html = '<table class="table table-bordered">';

    headers.forEach((h, i) => {
      // Skip the Solution/Remarks field entirely
      if (h === 'Solution/Remarks') return;

      if (!row[i]) return;
      let val = row[i];

      // Format Timestamp
      if (i === 1) {
        val = new Date(val).toLocaleString();
      }

      // Attachments column
      if (i === 12) {
        try {
          const arr = JSON.parse(val);
          val = arr
            .map(file => {
              const url = file.url || file.link || file.name;
              return `<a href="${url}" target="_blank">
                        <i class="bi bi-paperclip fs-5 me-2"></i>
                      </a>`;
            })
            .join('');
        } catch {
          val = `<a href="${val}" target="_blank">
                  <i class="bi bi-paperclip fs-5 me-2"></i>
                </a>`;
        }
      }

      // Additional Details column
      if (i === 14) {
        try {
          const obj = JSON.parse(val);
          let details = '';
          Object.entries(obj).forEach(([key, v]) => {
            if (v) {
              const label = key
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, c => c.toUpperCase());
              details += `<strong>${label}:</strong> ${v}<br>`;
            }
          });
          val = details;
        } catch {}
      }

      html += `<tr><th>${h}</th><td>${val}</td></tr>`;
    });

    html += '</table>';
    document.getElementById('ticketDetailsBody').innerHTML = html;
    new bootstrap.Modal(document.getElementById('ticketDetailsModal')).show();
  }

    function openReopen(id) {
      ticketToReopen = id;
      document.getElementById('reopenReason').value = '';
      new bootstrap.Modal(document.getElementById('reopenModal')).show();
    }

    const btn     = document.getElementById('submitReopen');
    const spinner = document.getElementById('submitReopenSpinner');

    document.getElementById('submitReopen').addEventListener('click', () => {
      const reason = document.getElementById('reopenReason').value.trim();
      if (!reason) {
        return showToast('Please provide a reason', true);
      }

      // 1) show loading:
      btn.disabled = true;
      spinner.classList.remove('hidden');

      const empId = document
        .getElementById('searchEmployeeId')
        .value
        .trim()
        .toUpperCase();

      google.script.run
        .withSuccessHandler(() => {
          showToast(`Ticket ${ticketToReopen} reopened`);
          // re-run your search to refresh the list:
          document.getElementById('searchForm').dispatchEvent(new Event('submit'));
          bootstrap.Modal.getInstance(
            document.getElementById('reopenModal')
          ).hide();
          // 3a) hide loading
          btn.disabled = false;
          spinner.classList.add('hidden');
        })
        .withFailureHandler(err => {
          showToast('Error: ' + err.message, true);
          // 3b) hide loading
          btn.disabled = false;
          spinner.classList.add('hidden');
        })
        .updateTicket(
          ticketToReopen,
          'Reopened',
          empId,
          `Reopen: ${reason}`
        );
    });

    function showError(msg) {
      document.getElementById('errorModalBody').innerHTML = msg;
      new bootstrap.Modal(document.getElementById('errorModal')).show();
    }

  </script>
</body>
</html>
