<!DOCTYPE html>
<html lang="en">
  <head>
    <base href="<?= ScriptApp.getService().getUrl() ?>" target="_top">
    <title>Logs - Yngen Group IT Ticketing System</title>
    <!-- Bootstrap 5 CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />
    <!-- Google Font -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
    />
    <!-- Bootstrap Icons CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.min.css"
    />
    <!-- Font Awesome (needed for sidebar icons) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f8f9fa;
        margin: 0;
        padding: 0;
      }

      /* ─── Sidebar Layout ─────────────────────────────────────────────────── */
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 60px;
        height: 100vh;
        background: #343a40;
        overflow-x: hidden;
        transition: width 0.3s;
        z-index: 1000;
      }
      .sidebar:hover {
        width: 200px;
      }
      .sidebar .logo {
        text-align: center;
        padding: 16px 0;
      }
      .sidebar .logo img {
        max-width: 32px;
      }
      .sidebar nav {
        display: flex;
        flex-direction: column;
      }
      .sidebar .nav-link {
        display: flex;
        align-items: center;
        color: #fff;
        padding: 12px 16px;
        text-decoration: none;
        white-space: nowrap;
        transition: background 0.2s;
      }
      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        background: #495057;
      }
      .sidebar .nav-link i {
        font-size: 1.5rem;
        width: 24px;
        margin-right: 12px;
      }
      .sidebar .nav-link span {
        opacity: 0;
        transition: opacity 0.3s;
      }
      .sidebar:hover .nav-link span {
        opacity: 1;
      }
      .sidebar .divider {
        border-top: 1px solid #495057;
        margin: 8px auto;
        width: 60%;
      }

      /* Push page content over when sidebar expands */
      .content {
        margin-left: 60px;
        transition: margin-left 0.3s;
        padding: 20px 40px;
      }
      .sidebar:hover + .content {
        margin-left: 200px;
      }
      /* ─────────────────────────────────────────────────────────────────────── */

      .container {
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
      }
      .card-custom {
        background-color: #fff;
        border-radius: 5px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      h2 {
        margin-bottom: 1.5rem;
      }
      .form-label {
        font-weight: 600;
      }
      .hidden {
        display: none !important;
      }
      .table-responsive {
        margin-top: 20px;
        max-height: 60vh;
        overflow-y: auto;
      }
      table {
        font-size: 1rem;
      }
      th.action-col, td.action-col {
        text-align: center;
        vertical-align: middle;
        width: 100px;
      }
      .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo">
        <img
          src="https://res.cloudinary.com/dbi3vgnnj/image/upload/v1746686322/YDC_Logo_1_orjbaj.png"
          alt="YNGEN"
        />
      </div>
      <nav>
        <a class="nav-link" href="?page=index">
          <i class="fa fa-pie-chart"></i><span>Dashboard</span>
        </a>
        <a class="nav-link" href="?page=createTicket">
          <i class="fa-solid fa-ticket"></i><span>Create Ticket</span>
        </a>
        <a class="nav-link" href="?page=searchStatus">
          <i class="fa-solid fa-magnifying-glass"></i><span>Search Status</span>
        </a>
        <a class="nav-link" href="?page=ithub">
          <i class="fa-solid fa-circle-info"></i><span>IT How-To Hub</span>
        </a>
        <div class="divider"></div>
        <a class="nav-link" href="?page=updateStatus">
          <i class="fa-solid fa-pen-to-square"></i><span>Update Ticket</span>
        </a>
        <a class="nav-link active" href="?page=logs">
          <i class="fa-solid fa-list"></i><span>Logs</span>
        </a>
      </nav>
    </div>

    <!-- Main content -->
    <div class="content">
      <div class="container">
        <div class="card-custom">
          <h2>Logs</h2>
          <!-- SEARCH FORM -->
          <form id="searchForm" class="d-flex mb-4 align-items-center">
            <input
              type="text"
              class="form-control me-2"
              id="searchITID"
              placeholder="Enter ITID Number"
              required
            />
            <button
              type="submit"
              class="btn btn-primary d-flex align-items-center"
              id="searchButton"
            >
              <span id="searchButtonText">Search</span>
              <span
                id="searchSpinner"
                class="spinner-border spinner-border-sm text-light ms-2 hidden"
                role="status"
                aria-hidden="true"
              ></span>
            </button>
            <button
              type="button"
              class="btn btn-secondary ms-2 hidden"
              id="printBtn"
              title="Print Logs"
            >
              <i class="bi bi-printer"></i>
            </button>
          </form>

          <!-- Page Size Selector -->
          <div class="row mb-4">
            <div class="col-auto">
              <label for="pageSizeSelect" class="form-label">Show per page:</label>
            </div>
            <div class="col-auto">
              <select
                id="pageSizeSelect"
                class="form-select"
                style="width:auto;"
              >
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="all">All</option>
              </select>
            </div>
          </div>

          <!-- LOGS RESULTS -->
          <div id="logsResults" class="table-responsive"></div>
          <!-- Pagination controls -->
          <div id="paginationControls" class="pagination-container"></div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Helper: force uppercase
      document.getElementById("searchITID").addEventListener("input", function() {
        this.value = this.value.toUpperCase();
      });
      function escapeHtml(str) {
        if (!str) return "";
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/\'/g, "&#x27;");
      }
      function sanitizeForTitle(str) {
        if (!str) return "";
        return str.replace(/[^A-Za-z0-9_-]/g, "_");
      }

      // Search handling with loading effect
      document.getElementById("searchForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const btn = document.getElementById("searchButton");
        const spinner = document.getElementById("searchSpinner");
        btn.disabled = true;
        spinner.classList.remove("hidden");
        const itid = document.getElementById("searchITID").value.trim().toUpperCase();
        if (!itid) {
          btn.disabled = false;
          spinner.classList.add("hidden");
          return;
        }
        document.getElementById("printBtn").classList.add("hidden");
        google.script.run
          .withSuccessHandler(function(res) {
            spinner.classList.add("hidden");
            btn.disabled = false;
            displayLogs(res);
          })
          .withFailureHandler(function(err) {
            spinner.classList.add("hidden");
            btn.disabled = false;
            document.getElementById("logsResults").innerHTML =
              '<div class="alert alert-danger">Error retrieving logs.</div>';
          })
          .getLogs();
      });

      // Pagination
      let currentPage = 1;
      const defaultPageSize = 10;
      function getPageSize() {
        return document.getElementById("pageSizeSelect").value;
      }
      document.getElementById("pageSizeSelect").addEventListener("change", function() {
        currentPage = 1;
        displayPagedResults();
        buildPagination();
      });

      let globalLogs = [];
      function displayLogs(result) {
        if (!result || !result.data) {
          document.getElementById("logsResults").innerHTML =
            '<div class="alert alert-danger">Error retrieving logs (no data).</div>';
          return;
        }
        const itid = document.getElementById("searchITID").value.trim().toUpperCase();
        globalLogs = result.data.filter(row =>
          (row[1] || "").toString().trim().toUpperCase() === itid
        );
        // 1) filter to this ITID …
        globalLogs = result.data.filter(row =>
          (row[1] || "").toString().trim().toUpperCase() === itid
        );
        // 2) … then sort by timestamp (column 0) descending
        globalLogs.sort((a, b) => new Date(b[0]) - new Date(a[0]));

        if (globalLogs.length === 0) {
          document.getElementById("logsResults").innerHTML =
            `<div class="alert alert-info">No logs found for ITID ${itid}.</div>`;
          document.getElementById("paginationControls").innerHTML = "";
        } else {
          document.getElementById("printBtn").classList.remove("hidden");
          currentPage = 1;
          displayPagedResults();
          buildPagination();
        }
      }

      function displayPagedResults() {
        const pageSizeVal = getPageSize();
        let pageData;
        if (pageSizeVal === "all") {
          pageData = globalLogs;
        } else {
          const size = parseInt(pageSizeVal, 10) || defaultPageSize;
          const start = (currentPage - 1) * size;
          pageData = globalLogs.slice(start, start + size);
        }
        let output = `<h4>Logs for ITID: ${document.getElementById("searchITID").value.trim().toUpperCase()}</h4>`;
        output += `<table class="table table-bordered"><thead><tr>
                     <th>Timestamp</th><th>Ticket ID</th><th>Action</th>
                     <th>User</th><th>Details</th><th>Remarks</th><th>Edit Reason</th>
                   </tr></thead><tbody>`;
        pageData.forEach(row => {
          output += "<tr>" +
                    row.map(cell => `<td>${escapeHtml(cell || "")}</td>`).join("") +
                    "</tr>";
        });
        output += "</tbody></table>";
        document.getElementById("logsResults").innerHTML = output;
      }

      function buildPagination() {
        const pageSizeVal = getPageSize();
        if (pageSizeVal === "all") {
          document.getElementById("paginationControls").innerHTML = "";
          return;
        }
        const size = parseInt(pageSizeVal, 10) || defaultPageSize;
        const totalPages = Math.ceil(globalLogs.length / size);
        if (totalPages <= 1) {
          document.getElementById("paginationControls").innerHTML = "";
          return;
        }
        let html = '<ul class="pagination">';
        html += `<li class="page-item${currentPage === 1 ? " disabled" : ""}">` +
                `<a class="page-link" href="#" onclick="changePage(${currentPage - 1});return false;">Previous</a>` +
                `</li>`;
        for (let i = 1; i <= totalPages; i++) {
          html += `<li class="page-item${currentPage === i ? " active" : ""}">` +
                  `<a class="page-link" href="#" onclick="changePage(${i});return false;">${i}</a>` +
                  `</li>`;
        }
        html += `<li class="page-item${currentPage === totalPages ? " disabled" : ""}">` +
                `<a class="page-link" href="#" onclick="changePage(${currentPage + 1});return false;">Next</a>` +
                `</li>`;
        html += "</ul>";
        document.getElementById("paginationControls").innerHTML = html;
      }

      function changePage(page) {
        currentPage = page;
        displayPagedResults();
        buildPagination();
      }

      // Print to PDF
      document.getElementById("printBtn").addEventListener("click", function() {
        const logsHtml = document.getElementById("logsResults").innerHTML;
        const itid = document.getElementById("searchITID").value.trim().toUpperCase();
        const safeITID = sanitizeForTitle(itid);
        const today = new Date();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        const yyyy = today.getFullYear();
        const dateString = mm + dd + yyyy;
        const docTitle = "Logs-" + safeITID + "-" + dateString;
        const newWin = window.open("", "_blank", "width=800,height=600");
        newWin.document.write("<html><head><title>" + docTitle + "</title>");
        newWin.document.write(
          "<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css'/>"
        );
        newWin.document.write(
          "<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.min.css'/>"
        );
        newWin.document.write(
          "<style>body{font-family:Arial,sans-serif;margin:1rem;}@media print{.table-bordered td,.table-bordered th{border:1px solid #dee2e6!important}}</style>"
        );
        newWin.document.write("</head><body class='container'>" + logsHtml + "</body></html>");
        newWin.document.close();
        newWin.focus();
        newWin.print();
        newWin.close();
      });
    </script>
  </body>
</html>
