<!DOCTYPE html>
<html>
  <head>
    <base href="<?= ScriptApp.getService().getUrl() ?>" target="_top">
    <title>Create Ticket - Yngen Group IT Ticketing System</title>
    <!-- Bootstrap 5 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
    <!-- Bootstrap Icons CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <style>
      body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
      .form-section, .summary-section {
        background-color: #fff; border-radius: 5px; padding: 20px; margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      .hidden { display: none; }
      .form-label { font-weight: 600; }
      .info-icon { color: #17a2b8; cursor: pointer; margin-left: 5px; font-size: 1rem; }
      .sidebar {
        position: fixed; top: 0; left: 0; width: 60px; height: 100vh; background: #343a40;
        overflow-x: hidden; transition: width 0.3s; z-index: 1000;
      }
      .sidebar:hover { width: 200px; }
      .sidebar .logo { text-align: center; padding: 16px 0; }
      .sidebar .logo img { max-width: 32px; }
      .sidebar nav { display: flex; flex-direction: column; }
      .sidebar .nav-link {
        display: flex; align-items: center; color: #fff; padding: 12px 16px; text-decoration: none;
        white-space: nowrap; transition: background 0.2s;
      }
      .sidebar .nav-link:hover, .sidebar .nav-link.active { background: #495057; }
      .sidebar .nav-link i { font-size: 1.5rem; width: 24px; margin-right: 12px; }
      .sidebar .nav-link span { opacity: 0; transition: opacity 0.3s; }
      .sidebar:hover .nav-link span { opacity: 1; }
      .sidebar .divider { border-top: 1px solid #495057; margin: 8px auto; width: 60%; }
      .content { margin-left: 60px; transition: margin-left 0.3s; padding: 20px 40px; }
      .sidebar:hover + .content { margin-left: 200px; }
      .tooltip-inner { max-width: 400px; white-space: normal; }
      .input-group-text { border-left: 0; }
      .input-group-text .btn { border: none; box-shadow: none; }
      .subtle { color:#6c757d; font-size:.9rem; }
      /* Loading overlay + skeletons */
      .loader-overlay { position: relative; }
      .loader-overlay .overlay {
        position: absolute; inset: 0;
        background: rgba(255,255,255,.6);
        display: none; align-items: center; justify-content: center;
        z-index: 10;
      }
      .loader-overlay.loading .overlay { display: flex; }

      .skeleton { position: relative; overflow: hidden; background: #e9ecef; border-radius: .375rem; }
      .skeleton::after {
        content: ""; position: absolute; inset: 0; transform: translateX(-100%);
        background: linear-gradient(90deg, transparent, rgba(255,255,255,.6), transparent);
        animation: shimmer 1.2s infinite;
      }
      .skel-line { height: 1rem; margin-bottom: .5rem; }
      .skel-input { height: 2.4rem; }
      @keyframes shimmer { 100% { transform: translateX(100%); } }

    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo">
        <img src="https://res.cloudinary.com/dbi3vgnnj/image/upload/v1746686322/YDC_Logo_1_orjbaj.png" alt="YNGEN" />
      </div>
      <nav>
        <a class="nav-link" href="?page=index"><i class="fa fa-pie-chart"></i><span>Dashboard</span></a>
        <a class="nav-link active" href="?page=createTicket"><i class="fa-solid fa-ticket"></i><span>Create Ticket</span></a>
        <a class="nav-link" href="?page=searchStatus"><i class="fa-solid fa-magnifying-glass"></i><span>Search Status</span></a>
        <a class="nav-link" href="?page=ithub"><i class="fa-solid fa-circle-info"></i><span>IT How-To Hub</span></a>
        <div class="divider"></div>
        <a class="nav-link" href="?page=updateStatus"><i class="fa-solid fa-pen-to-square"></i><span>Update Ticket</span></a>
      </nav>
    </div>

    <!-- Main content -->
    <div class="content">
      <div class="container my-4">
        <div class="row">
          <!-- Left Column: Form -->
          <div class="col-md-8">
            <div class="form-section">
              <h2 class="mb-4">Create Ticket</h2>
              <form id="ticketForm">
                <!-- Personal Details -->
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="uniqueCode" class="form-label">
                      Employee Code
                      <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" data-bs-placement="top"
                         title="Enter your Employee ID + MMMDD (birth date) + last 3 digits of your SSS."></i>
                    </label>
                    <div class="input-group">
                      <input type="password" class="form-control" id="uniqueCode" placeholder="Enter Your Employee Code" required />
                      <span class="input-group-text bg-white border-start-0">
                        <button class="btn btn-link p-0 text-decoration-none" type="button" id="toggleUnique" tabindex="-1">
                          <i class="bi bi-eye"></i>
                        </button>
                      </span>
                      <button type="button" class="btn btn-success" id="verifyButton">
                        <span id="verifyButtonText">Verify</span>
                        <span id="verifySpinner" class="spinner-border spinner-border-sm text-light ms-2 hidden" role="status" aria-hidden="true"></span>
                      </button>
                    </div>
                  </div>
                  <input type="hidden" id="employeeId" name="employeeId" />
                  <div class="col-md-6">
                    <label for="employeeName" class="form-label">Employee Name</label>
                    <input type="text" class="form-control" id="employeeName" name="employeeName" readonly required />
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="lineOfBusiness" class="form-label">Line of Business</label>
                    <input type="text" class="form-control" id="lineOfBusiness" name="lineOfBusiness" readonly required />
                  </div>
                  <div class="col-md-6">
                    <label for="officeSite" class="form-label">Office Site</label>
                    <select class="form-control" id="officeSite" name="officeSite" required>
                      <option value="">--Select Office Site--</option>
                      <option>Yngen</option><option>Sabak</option><option>ATS</option><option>Richmond</option><option>Richville</option><option>UB</option><option>The Rocks</option>
                    </select>
                  </div>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="email" class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="email" name="email" required />
                  </div>
                  <div class="col-md-6">
                    <label for="priorityLevel" class="form-label">
                      Priority Level
                      <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" data-bs-sanitize="false"
                         title="(P1) Critical – all users blocked<br>(P2) High – some users/locations blocked<br>(P3) Medium – partial impact<br>(P4) Low – general requests"></i>
                    </label>
                    <select class="form-control" id="priorityLevel" name="priorityLevel" required>
                      <option value="">--Select Priority--</option>
                      <option>Critical</option><option>High</option><option>Medium</option><option>Low</option>
                    </select>
                  </div>
                </div>

                <!-- Category -->
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="ticketCategory" class="form-label">
                      Ticket Category
                      <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" data-bs-sanitize="false"
                         title="Incident – something broken<br>Service Request – asking IT to provide/enable something (may need approval)"></i>
                    </label>
                    <select class="form-control" id="ticketCategory" name="ticketCategory" required>
                      <option value="">--Select Category--</option>
                      <option>Incident</option>
                      <option>Service Request</option>
                    </select>
                  </div>
                </div>

                <!-- Incident (keep your three basics for now) -->
                <div id="incidentFields" class="hidden">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="detailedLocation" class="form-label">Location</label>
                      <input type="text" class="form-control" id="detailedLocation" name="detailedLocation">
                    </div>
                    <div class="col-md-6">
                      <label for="issueClassification" class="form-label">Classification</label>
                      <select class="form-control" id="issueClassification" name="issueClassification">
                        <option value="">--Select--</option>
                        <option>Hardware</option><option>Software</option><option>Server</option><option>Network</option><option>IT Asset</option><option>Other</option>
                      </select>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="issueDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="issueDescription" name="issueDescription" rows="3"></textarea>
                  </div>
                </div>

                <!-- Service Request (fully dynamic from sheet) -->
                <div id="serviceFields" class="hidden loader-overlay">
                  <!-- overlay shown while fetching meta/fields -->
                  <div class="overlay" aria-live="polite" aria-busy="true">
                    <div class="text-center">
                      <div class="spinner-border" role="status" aria-label="Loading"></div>
                      <div class="mt-2 small text-muted">Fetching data…</div>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="requestType" class="form-label">Request Type</label>
                    <select class="form-control" id="requestType" name="requestType" disabled>
                      <option value="">--Select Request Type--</option>
                    </select>
                    <div class="subtle mt-1" id="requestTypeHint"></div>
                  </div>

                  <div class="mb-3 hidden" id="subtypeWrap">
                    <label for="subtype" class="form-label">Subtype</label>
                    <select class="form-control" id="subtype" name="subtype"></select>
                  </div>

                  <!-- Rendered dynamic fields go here -->
                  <div id="additionalQuestions"></div>
                </div>

                <!-- Attachments + Remarks -->
                <div class="mb-3">
                  <label for="attachment" class="form-label">Attach File(s)
                    <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Attach any relevant files (optional)."></i>
                  </label>
                  <input type="file" class="form-control" id="attachment" name="attachment" multiple
                         accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation">
                </div>
                <div class="mb-3">
                  <label for="remarks" class="form-label">Remarks</label>
                  <textarea class="form-control" id="remarks" name="remarks" rows="3"></textarea>
                </div>

                <button type="submit" class="btn btn-primary d-flex align-items-center" id="submitButton">
                  <span id="submitButtonText">Submit Ticket</span>
                  <span id="submitSpinner" class="spinner-border spinner-border-sm ms-2 hidden" role="status" aria-hidden="true"></span>
                </button>
              </form>
            </div>
          </div>

          <!-- Right Column: Tips -->
          <div class="col-md-4">
            <div class="summary-section">
              <h4>Tips</h4>
              <ul class="list-unstyled">
                <li>- Verify your employee code to auto-fill details.</li>
                <li>- Attach files when available.</li>
                <li>- Fill all required fields to avoid delays.</li>
              </ul>
              <hr />
              <p class="text-muted mb-0">For help, contact IT Support.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ticket Success Modal -->
    <div class="modal fade" id="ticketModal" tabindex="-1" aria-labelledby="ticketModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="ticketModalLabel">Ticket Submitted</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body" id="ticketModalBody"></div>
        <div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button></div>
      </div></div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="errorModalLabel">Error</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body" id="errorModalBody"></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
      </div></div>
    </div>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // ─── Utilities ──────────────────────────────────────────────────────────
      const $ = sel => document.querySelector(sel);
      const $$ = sel => Array.from(document.querySelectorAll(sel));
      const show = el => el.classList.remove('hidden');
      const hide = el => el.classList.add('hidden');

      function showError(html) {
        $('#errorModalBody').innerHTML = html;
        new bootstrap.Modal($('#errorModal')).show();
      }
      function showSuccess(html) {
        $('#ticketModalBody').innerHTML = html;
        new bootstrap.Modal($('#ticketModal')).show();
      }
      function setLoading(sectionEl, isLoading) {
        if (!sectionEl) return;
        sectionEl.classList.toggle('loading', !!isLoading);
      }

      function renderSkeleton(count = 4) {
        return Array.from({ length: count }).map(() => `
          <div class="mb-3">
            <div class="skeleton skel-line" style="width:36%"></div>
            <div class="skeleton skel-input"></div>
          </div>
        `).join('');
      }

      // Tooltips
      document.addEventListener('DOMContentLoaded', () => {
        $$('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
      });

      // Uppercase behaviors
      $('#employeeId').addEventListener('input', function(){ this.value = this.value.toUpperCase(); });
      const unique = $('#uniqueCode');
      unique.addEventListener('input', () => unique.value = unique.value.toUpperCase());

      // Toggle mask
      $('#toggleUnique').addEventListener('click', function() {
        const icon = this.querySelector('i');
        if (unique.type === 'password') { unique.type = 'text'; icon.classList.replace('bi-eye', 'bi-eye-slash'); }
        else { unique.type = 'password'; icon.classList.replace('bi-eye-slash', 'bi-eye'); }
      });

      // Verify employee code
      $('#verifyButton').addEventListener('click', function() {
        const btn = this, spinner = $('#verifySpinner'), txt = $('#verifyButtonText');
        const input = unique.value.trim();
        if (!input) return showError('Please enter your Unique Code.');
        btn.disabled = true; txt.textContent = 'Verifying…'; spinner.classList.remove('hidden');

        google.script.run
          .withSuccessHandler(emp => {
            btn.disabled = false; txt.textContent = 'Verify'; spinner.classList.add('hidden');
            if (emp) {
              $('#employeeId').value = emp.id;
              $('#employeeName').value = emp.name;
              $('#lineOfBusiness').value = emp.lob;
            } else {
              showError('<b>We couldn’t verify your Unique Code.</b><br>Check the format and try again.');
              $('#employeeName').value = ''; $('#lineOfBusiness').value = '';
            }
          })
          .withFailureHandler(err => {
            btn.disabled = false; txt.textContent = 'Verify'; spinner.classList.add('hidden');
            showError('Error verifying code: ' + (err.message || err));
          })
          .verifyEmployeeByCode(input);
      });

      // Category toggle + load meta for Service Request
      $('#ticketCategory').addEventListener('change', function() {
        const cat = this.value;
        if (cat === 'Incident') {
          show($('#incidentFields')); hide($('#serviceFields'));
          $('#detailedLocation').disabled = false;
          $('#issueClassification').disabled = false;
          $('#issueDescription').disabled = false;
        } else if (cat === 'Service Request') {
        hide($('#incidentFields')); show($('#serviceFields'));

        // prep UI
        $('#requestType').disabled = true;
        $('#requestType').innerHTML = '<option value="">Loading…</option>';
        $('#subtypeWrap').classList.add('hidden');
        $('#subtype').innerHTML = '';
        $('#additionalQuestions').innerHTML = '';
        $('#requestTypeHint').innerHTML =
          '<span class="spinner-border spinner-border-sm me-2"></span>Loading request types…';

        // turn on overlay
        setLoading($('#serviceFields'), true);

        // fetch meta
        google.script.run
          .withSuccessHandler(meta => {
            const select = $('#requestType');
            select.innerHTML = '<option value="">--Select Request Type--</option>';
            (meta.requestTypes || []).forEach(rt => {
              const opt = document.createElement('option');
              opt.value = rt.name; opt.textContent = rt.name;
              select.appendChild(opt);
            });
            select.disabled = false;
            $('#requestTypeHint').textContent = 'Pick a request type to load fields.';
            setLoading($('#serviceFields'), false);
          })
          .withFailureHandler(err => {
            $('#requestType').innerHTML = '<option value="">--Select Request Type--</option>';
            $('#requestTypeHint').textContent = '';
            setLoading($('#serviceFields'), false);
            showError('Failed to load dynamic questions meta: ' + (err.message || err));
          })
          .getDQMeta('Service Request');
        } else {
          hide($('#incidentFields')); hide($('#serviceFields'));
        }
      });
      // initialize
      $('#ticketCategory').dispatchEvent(new Event('change'));

      // Request Type -> maybe show Subtype, then render fields
      $('#requestType').addEventListener('change', function() {
        const cat = $('#ticketCategory').value;
        const req = this.value;

        $('#additionalQuestions').innerHTML = '';
        $('#subtypeWrap').classList.add('hidden');
        $('#subtype').innerHTML = '';

        if (!req) return;

        // show loader state while we figure out subtypes
        $('#requestTypeHint').innerHTML =
          '<span class="spinner-border spinner-border-sm me-2"></span>Checking subtypes…';
        setLoading($('#serviceFields'), true);

        google.script.run
          .withSuccessHandler(meta => {
            const found = (meta.requestTypes || []).find(x => x.name === req);
            const subs = (found && found.subtypes) ? found.subtypes : [];

            if (subs.length) {
              $('#subtype').innerHTML =
                '<option value="">--Select Subtype--</option>' + subs.map(s => `<option>${s}</option>`).join('');
              $('#subtypeWrap').classList.remove('hidden');
              $('#requestTypeHint').textContent = 'Select a subtype to continue.';
              setLoading($('#serviceFields'), false);
            } else {
              // no subtype -> fetch fields immediately, show skeletons
              $('#requestTypeHint').textContent = 'Loading fields…';
              $('#additionalQuestions').innerHTML = renderSkeleton(4);
              loadAndRenderFields(cat, req, '');
            }
          })
          .withFailureHandler(err => {
            $('#requestTypeHint').textContent = '';
            setLoading($('#serviceFields'), false);
            showError('Failed to load subtypes: ' + (err.message || err));
          })
          .getDQMeta(cat);
      });

      // Subtype change -> render fields
      $('#subtype').addEventListener('change', function() {
        const cat = $('#ticketCategory').value;
        const req = $('#requestType').value;
        const sub = this.value || '';
        $('#additionalQuestions').innerHTML = '';
        if (!req) return;

        $('#requestTypeHint').textContent = 'Loading fields…';
        $('#additionalQuestions').innerHTML = renderSkeleton(4);
        loadAndRenderFields(cat, req, sub);
      });

      function loadAndRenderFields(category, requestType, subtype) {
        setLoading($('#serviceFields'), true);
        google.script.run
          .withSuccessHandler(fields => {
            renderDynamicFields(fields);
            $('#requestTypeHint').textContent = fields && fields.length
              ? 'Fill in the required details below.'
              : 'No additional details required.';
            setLoading($('#serviceFields'), false);
          })
          .withFailureHandler(err => {
            setLoading($('#serviceFields'), false);
            $('#requestTypeHint').textContent = '';
            showError('Failed to load fields: ' + (err.message || err));
          })
          .getDQFields(category, requestType, subtype);
      }

      function renderDynamicFields(fields) {
        const c = $('#additionalQuestions');
        c.innerHTML = '';
        if (!fields || !fields.length) {
          c.innerHTML = '<div class="text-muted">No additional details required.</div>';
          return;
        }
        fields.forEach(f => {
          const id = 'dyn_' + f.Key;
          const wrap = document.createElement('div');
          wrap.className = 'mb-3';
          const label = document.createElement('label');
          label.className = 'form-label';
          label.setAttribute('for', id);
          label.innerHTML = f.Label + (f.Help ? ` <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" title="${escapeHtml(f.Help)}"></i>` : '');
          wrap.appendChild(label);

          let input;
          switch(f.Type) {
            case 'textarea':
              input = document.createElement('textarea');
              input.rows = 2;
              break;
            case 'select':
              input = document.createElement('select');
              (f.Options || []).forEach(opt => {
                const o = document.createElement('option');
                o.value = opt; o.textContent = opt; input.appendChild(o);
              });
              const empty = document.createElement('option');
              empty.value = ''; empty.textContent = '--Select--';
              input.insertBefore(empty, input.firstChild);
              break;
            case 'date':
            case 'email':
            case 'number':
            case 'text':
              input = document.createElement('input');
              input.type = f.Type;
              break;
            case 'checkbox':
              input = document.createElement('input');
              input.type = 'checkbox';
              input.classList.add('form-check-input');
              label.classList.add('form-check-label');
              wrap.classList.add('form-check');
              break;
            default:
              input = document.createElement('input');
              input.type = 'text';
          }

          input.id = id;
          input.dataset.key = f.Key;
          input.dataset.dyn = '1';
          if (f.Placeholder && input.tagName !== 'SELECT' && input.type !== 'checkbox') input.placeholder = f.Placeholder;
          if (f.Required) input.required = true;
          if (!wrap.classList.contains('form-check')) input.classList.add('form-control');

          wrap.appendChild(input);
          c.appendChild(wrap);
        });

        // Initialize tooltips created in dynamic area
        $$('#additionalQuestions [data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
      }

      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

      // Attachments → base64 packer
      function filesToJson(fileInput) {
        return new Promise(resolve => {
          const files = Array.from(fileInput.files || []);
          if (!files.length) return resolve('');
          const readers = files.map(file => new Promise(res => {
            const fr = new FileReader();
            fr.onload = () => {
              const base64 = fr.result.split(',')[1]; // remove "data:*/*;base64,"
              res({ name: file.name, type: file.type, data: base64 });
            };
            fr.readAsDataURL(file);
          }));
          Promise.all(readers).then(arr => resolve(JSON.stringify(arr)));
        });
      }

      // Submit
      $('#ticketForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = $('#submitButton'), spn = $('#submitSpinner'), txt = $('#submitButtonText');
        btn.disabled = true; spn.classList.remove('hidden'); txt.textContent = 'Submitting…';

        try {
          const category = $('#ticketCategory').value;
          const data = {
            employeeId: $('#employeeId').value.trim(),
            employeeName: $('#employeeName').value.trim(),
            lineOfBusiness: $('#lineOfBusiness').value.trim(),
            officeSite: $('#officeSite').value,
            email: $('#email').value.trim(),
            ticketCategory: category,
            priorityLevel: $('#priorityLevel').value,
            // Incident fixed
            detailedLocation: $('#detailedLocation')?.value || '',
            issueClassification: $('#issueClassification')?.value || '',
            issueDescription: $('#issueDescription')?.value || '',
            // Service Request dynamic
            requestType: $('#requestType')?.value || '',
            remarks: $('#remarks').value || ''
          };

          // Collect dynamic fields as an object
          const dynInputs = $$('[data-dyn="1"]');
          if (dynInputs.length) {
            const details = {};
            dynInputs.forEach(el => {
              const key = el.dataset.key;
              let val = '';
              if (el.type === 'checkbox') { val = el.checked ? 'Yes' : 'No'; }
              else { val = (el.value || '').trim(); }
              details[key] = val;
            });
            data.additionalDetails = JSON.stringify(details);
          } else {
            data.additionalDetails = '';
          }

          // Attachments
          data.attachments = await filesToJson($('#attachment'));

          google.script.run
            .withSuccessHandler(ticketNumber => {
              btn.disabled = false; spn.classList.add('hidden'); txt.textContent = 'Submit Ticket';
              showSuccess('Your ticket <b>' + ticketNumber + '</b> has been submitted successfully.');
              // Reset form minimal
              // (keep email/site for convenience)
              $('#issueDescription').value = '';
              $('#remarks').value = '';
              $('#additionalQuestions').innerHTML = '';
              $('#attachment').value = '';
            })
            .withFailureHandler(err => {
              btn.disabled = false; spn.classList.add('hidden'); txt.textContent = 'Submit Ticket';
              showError('Submit failed: ' + (err.message || err));
            })
            .createTicket(data);

        } catch (err) {
          btn.disabled = false; spn.classList.add('hidden'); txt.textContent = 'Submit Ticket';
          showError('Unexpected error: ' + (err.message || err));
        }
      });
    </script>
  </body>
</html>
