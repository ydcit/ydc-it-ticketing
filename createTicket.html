<!DOCTYPE html>
<html>
  <head>
    <base href="<?= ScriptApp.getService().getUrl() ?>" target="_top">
    <title>Create Ticket - Yngen Group IT Ticketing System</title>
    <!-- Bootstrap 5 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" />
    <!-- Bootstrap Icons CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
      .form-section, .summary-section {
        background-color: #fff;
        border-radius: 5px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      .hidden { display: none; }
      .form-label { font-weight: 600; }
      .info-icon {
        color: #17a2b8;
        cursor: pointer;
        margin-left: 5px;
        font-size: 1rem;
      }
      /* ─── Sidebar Layout ─────────────────────────────────────────────────── */
      .sidebar {
        position: fixed;
        top: 0; left: 0;
        width: 60px; height: 100vh;
        background: #343a40;
        overflow-x: hidden;
        transition: width 0.3s;
        z-index: 1000;
      }
      .sidebar:hover { width: 200px; }

      .sidebar .logo {
        text-align: center;
        padding: 16px 0;
      }
      .sidebar .logo img { max-width: 32px; }

      .sidebar nav {
        display: flex;
        flex-direction: column;
      }
      .sidebar .nav-link {
        display: flex;
        align-items: center;
        color: #fff;
        padding: 12px 16px;
        text-decoration: none;
        white-space: nowrap;
        transition: background 0.2s;
      }
      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        background: #495057;
      }
      .sidebar .nav-link i {
        font-size: 1.5rem;
        width: 24px;
        margin-right: 12px;
      }
      .sidebar .nav-link span {
        opacity: 0;
        transition: opacity 0.3s;
      }
      .sidebar:hover .nav-link span {
        opacity: 1;
      }
      .sidebar .divider {
        border-top: 1px solid #495057;
        margin: 8px auto;
        width: 60%;
      }

      /* Push page content over when sidebar expands */
      .content {
        margin-left: 60px;
        transition: margin-left 0.3s;
        padding: 20px 40px;
      }
      .sidebar:hover + .content {
        margin-left: 200px;
      }
      .tooltip-inner {
        max-width: 400px;      /* adjust to your desired width */
        white-space: normal;   /* allow multiple lines, wrapping on spaces */
      }
      /* remove that little line between the field and the eye icon */
      .input-group-text {
        border-left: 0;
      }
      /* make the eye button itself completely borderless */
      .input-group-text .btn {
        border: none;
        box-shadow: none;
      }
    </style>
  </head>
  <body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <img src="https://res.cloudinary.com/dbi3vgnnj/image/upload/v1746686322/YDC_Logo_1_orjbaj.png" alt="YNGEN" />
    </div>
    <nav>
      <a class="nav-link" href="?page=index">
        <i class="fa fa-pie-chart"></i><span>Dashboard</span>
      </a>
      <a class="nav-link active" href="?page=createTicket">
        <i class="fa-solid fa-ticket"></i><span>Create Ticket</span>
      </a>
      <a class="nav-link" href="?page=searchStatus">
        <i class="fa-solid fa-magnifying-glass"></i><span>Search Status</span>
      </a>
      <a class="nav-link" href="?page=ithub">
        <i class="fa-solid fa-circle-info"></i><span>IT How-To Hub</span>
      </a>
      <div class="divider"></div>
      <a class="nav-link" href="?page=updateStatus">
        <i class="fa-solid fa-pen-to-square"></i><span>Update Ticket</span>
      </a>
    </nav>
  </div>

  <!-- Main content -->
  <div class="content">


    <!-- Main Container -->
    <div class="container my-4">
      <div class="row">
        <!-- Left Column: Form -->
        <div class="col-md-8">
          <div class="form-section">
            <h2 class="mb-4">Create Ticket</h2>
            <form id="ticketForm">
              <!-- Personal Details (required) -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="uniqueCode" class="form-label">
                    Employee Code
                    <i
                      class="bi bi-info-circle-fill info-icon"
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      title="Please enter your unique code, which is composed of your Employee ID followed by the three-letter month and two-digit day of your birthdate, and ending with the last three digits of your SSS number."
                    ></i>
                  </label>
                  <div class="input-group">
                    <!-- 1) make it a password so it’s masked by default -->
                    <input
                      type="password"
                      class="form-control"
                      id="uniqueCode"
                      placeholder="Enter Your Employee Code"
                      required
                    />

                    <!-- 2) the eye toggle, as an input-group append -->
                    <span class="input-group-text bg-white border-start-0">
                      <button
                        class="btn btn-link p-0 text-decoration-none"
                        type="button"
                        id="toggleUnique"
                        tabindex="-1"
                      >
                        <i class="bi bi-eye"></i>
                      </button>
                    </span>

                    <!-- 3) your existing Verify button -->
                    <button type="button" class="btn btn-success" id="verifyButton">
                      <span id="verifyButtonText">Verify</span>
                      <span
                        id="verifySpinner"
                        class="spinner-border spinner-border-sm text-light ms-2 hidden"
                        role="status"
                        aria-hidden="true"
                      ></span>
                    </button>
                  </div>
                </div>
                <input type="hidden" id="employeeId" name="employeeId" />
                <div class="col-md-6">
                  <label for="employeeName" class="form-label">Employee Name</label>
                  <input type="text" class="form-control" id="employeeName" name="employeeName" readonly required />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="lineOfBusiness" class="form-label">Line of Business</label>
                  <input type="text" class="form-control" id="lineOfBusiness" name="lineOfBusiness" readonly required />
                </div>
                <div class="col-md-6">
                  <label for="officeSite" class="form-label">Office Site</label>
                  <select class="form-control" id="officeSite" name="officeSite" required>
                    <option value="">--Select Office Site--</option>
                    <option value="Yngen">Yngen</option>
                    <option value="Sabak">Sabak</option>
                    <option value="ATS">ATS</option>
                    <option value="Richmond">Richmond</option>
                    <option value="Richville">Richville</option>
                    <option value="UB">UB</option>
                    <option value="The Rocks">The Rocks</option>
                  </select>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="email" class="form-label">Email Address</label>
                  <input type="email" class="form-control" id="email" name="email" required />
                </div>
                <div class="col-md-6">
                  <label for="priorityLevel" class="form-label">
                      Priority Level
                      <i
                        class="bi bi-info-circle-fill info-icon"
                        data-bs-toggle="tooltip"
                        data-bs-placement="top"
                        data-bs-html="true"
                        data-bs-sanitize="false"
                        title="
                          Please assess your concern carefully and be truthful with your choice.<br>
                          (P1) Critical – An issue that affects all users from performing critical business operations.<br>
                          (P2) High – An issue that affects some users or locations from performing critical business operations.<br>
                          (P3) Medium – An issue that affects some features or users, but is not business-critical.<br>
                          (P4) Low – The service is unaffected. General requests, concerns, and tasks.
                        ">
                      </i>
                    </label>
                    <select class="form-control" id="priorityLevel" name="priorityLevel" required>
                    <option value="">--Select Priority--</option>
                    <option value="Critical">Critical</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                  </select>
                </div>
              </div>
              <!-- Ticket Category (required) -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="ticketCategory" class="form-label">
                      Ticket Category
                      <i
                        class="bi bi-info-circle-fill info-icon"
                        data-bs-toggle="tooltip"
                        data-bs-placement="top"
                        data-bs-html="true"
                        data-bs-sanitize="false"
                        title="
                          Incident – An error or event causing a service to stop working properly.<br>
                          Service Request – A request to fulfill or provide something, which may require prior approval from your immediate head.
                        ">
                      </i>
                    </label>
                    <select class="form-control" id="ticketCategory" name="ticketCategory" required>
                    <option value="">--Select Category--</option>
                    <option value="Incident">Incident</option>
                    <option value="Service Request">Service Request</option>
                  </select>
                </div>
              </div>
              <!-- Conditional Fields (not required) -->
              <div id="incidentFields" class="hidden">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="detailedLocation" class="form-label">Location</label>
                    <input type="text" class="form-control" id="detailedLocation" name="detailedLocation">
                  </div>
                  <div class="col-md-6">
                    <label for="issueClassification" class="form-label">
                        Classification
                        <i
                          class="bi bi-info-circle-fill info-icon"
                          data-bs-toggle="tooltip"
                          data-bs-placement="top"
                          data-bs-html="true"
                          data-bs-sanitize="false"
                          title="
                            Network Related (e.g. Internet Connection Problem, File Transfer, Printer Connection Problem, etc.)<br>
                            Hardware Related (e.g. Faulty Keyboard & Mouse, Monitor Display Distortion, Overheating Computer, etc.)<br>
                            Software Related (e.g. Application Error, System Error, Driver Problem, Installation Request, etc.)<br>
                            Server Related (e.g. File Access in Server, Account Creation, Password Reset, etc.)<br>
                            IT Asset Related (e.g. Asset Retirement, Asset Acquisition, Transfer of Asset, etc.)<br>
                            ID Card Related (e.g. ID Creation Request, ID Reprint, Wrong Info, etc.)
                          ">
                        </i>
                      </label>
                      <select class="form-control" id="issueClassification" name="issueClassification">
                      <option value="">--Select--</option>
                      <option value="Hardware">Hardware</option>
                      <option value="Software">Software</option>
                      <option value="Server">Server</option>
                      <option value="Network">Network</option>
                      <option value="IT Asset">IT Asset</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="issueDescription" class="form-label">Description</label>
                  <textarea class="form-control" id="issueDescription" name="issueDescription" rows="3"></textarea>
                </div>
              </div>
              <div id="serviceFields" class="hidden">
                <div class="mb-3">
                  <label for="requestType" class="form-label">Request Type</label>
                  <select class="form-control" id="requestType" name="requestType">
                    <option value="">--Select Request Type--</option>
                    <option value="Access Requests">Access Requests</option>
                    <option value="Hardware Requests">Hardware Requests</option>
                    <option value="Software Requests">Software Requests</option>
                    <option value="Network & Security Requests">Network & Security Requests</option>
                    <option value="User Account Management">User Account Management</option>
                    <option value="Data & Storage Requests">Data & Storage Requests</option>
                    <option value="Telephony/Communication Requests">Telephony/Communication Requests</option>
                    <option value="Maintenance & Scheduled Tasks">Maintenance & Scheduled Tasks</option>
                    <option value="IT Consultation & Advisory">IT Consultation & Advisory</option>
                    <option value="Workstation Setup & Transfer Requests">Workstation Setup & Transfer Requests</option>
                  </select>
                </div>
                <!-- Container for dynamically generated additional questions (fields here are optional) -->
                <div id="additionalQuestions"></div>
              </div>
              <!-- Generic Attach File Input and Remarks (optional) -->
              <div class="mb-3">
                <label for="attachment" class="form-label">Attach File(s)
                  <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Attach any relevant files (optional)."></i>
                </label>
                <input
                type="file"
                class="form-control"
                id="attachment"
                name="attachment"
                multiple
                accept="
                  image/*,
                  application/pdf,
                  application/msword,
                  application/vnd.openxmlformats-officedocument.wordprocessingml.document,
                  application/vnd.ms-excel,
                  application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,
                  application/vnd.ms-powerpoint,
                  application/vnd.openxmlformats-officedocument.presentationml.presentation
                "
              >
              </div>
              <div class="mb-3">
                <label for="remarks" class="form-label">Remarks
                  <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Any extra remarks or information."></i>
                </label>
                <textarea class="form-control" id="remarks" name="remarks" rows="3"></textarea>
              </div>
              <button type="submit" class="btn btn-primary d-flex align-items-center" id="submitButton">
                <span id="submitButtonText">Submit Ticket</span>
                <span id="submitSpinner" class="spinner-border spinner-border-sm ms-2 hidden" role="status" aria-hidden="true"></span>
              </button>
            </form>
          </div>
        </div>
        <!-- Right Column: Tips -->
        <div class="col-md-4">
          <div class="summary-section">
            <h4>Tips</h4>
            <ul class="list-unstyled">
              <li>- Verify your employee ID first to auto-fill details.</li>
              <li>- Attach files when available.</li>
              <li>- Fill in all personal details for proper processing.</li>
            </ul>
            <hr />
            <p class="text-muted mb-0">For more help, please contact IT Support.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Ticket Success Modal -->
    <div class="modal fade" id="ticketModal" tabindex="-1" aria-labelledby="ticketModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="ticketModalLabel">Ticket Submitted</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="ticketModalBody"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="errorModalLabel">Error</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="errorModalBody"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Initialize tooltips on load.
      document.addEventListener("DOMContentLoaded", function(){
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
      });

      document.getElementById("employeeId").addEventListener("input", function() {
        this.value = this.value.toUpperCase();
      });

      // always-uppercase as you type
      document.getElementById("uniqueCode").addEventListener("input", function(){
        this.value = this.value.toUpperCase();
      });

      // Employee verification with loading indicator.
        document.getElementById("verifyButton").addEventListener("click", function() {
        const btn     = this;
        const spinner = document.getElementById("verifySpinner");
        const txt     = document.getElementById("verifyButtonText");
        const input   = document.getElementById("uniqueCode").value.trim();

        if (!input) {
          return showError("Please enter your Unique Code.");
        }
        btn.disabled = true;
        txt.textContent = "Verifying…";
        spinner.classList.remove("hidden");

        google.script.run
          .withSuccessHandler(emp => {
            btn.disabled = false;
            txt.textContent = "Verify";
            spinner.classList.add("hidden");

            if (emp) {
              document.getElementById("employeeId").value      = emp.id;
              document.getElementById("employeeName").value    = emp.name;
              document.getElementById("lineOfBusiness").value  = emp.lob;
            } else {
              showError(
              '<b>We couldn’t verify your Unique Code.</b><br>' +
              'Your Unique Code is your Employee ID + your birth date (MMMDD) + the last three digits of your SSS.<br>' +
              'Please double-check this combination and try again.');
              document.getElementById("employeeName").value   = "";
              document.getElementById("lineOfBusiness").value = "";
            }
          })
          .withFailureHandler(err => {
            btn.disabled = false;
            txt.textContent = "Verify";
            spinner.classList.add("hidden");
            showError("Error verifying code: " + (err.message || err));
          })
          .verifyEmployeeByCode(input);
      });

      // always uppercase and toggle mask for Employee Code
      const unique = document.getElementById("uniqueCode");
      unique.addEventListener("input", () => unique.value = unique.value.toUpperCase());

      document.getElementById("toggleUnique").addEventListener("click", function() {
        const icon = this.querySelector("i");
        if (unique.type === "password") {
          unique.type = "text";
          icon.classList.replace("bi-eye", "bi-eye-slash");
        } else {
          unique.type = "password";
          icon.classList.replace("bi-eye-slash", "bi-eye");
        }
      });

      // Toggle Incident/Service Request fields.
      document.getElementById("ticketCategory").addEventListener("change", function() {
        const cat = this.value;
        if (cat === "Incident") {
          document.getElementById("incidentFields").classList.remove("hidden");
          document.getElementById("serviceFields").classList.add("hidden");
          document.getElementById("detailedLocation").disabled = false;
          document.getElementById("issueClassification").disabled = false;
          document.getElementById("issueDescription").disabled = false;
          document.getElementById("requestType").disabled = true;
        } else if (cat === "Service Request") {
          document.getElementById("serviceFields").classList.remove("hidden");
          document.getElementById("incidentFields").classList.add("hidden");
          document.getElementById("detailedLocation").disabled = true;
          document.getElementById("issueClassification").disabled = true;
          document.getElementById("issueDescription").disabled = true;
          document.getElementById("requestType").disabled = false;
        } else {
          document.getElementById("incidentFields").classList.add("hidden");
          document.getElementById("serviceFields").classList.add("hidden");
          document.getElementById("detailedLocation").disabled = true;
          document.getElementById("issueClassification").disabled = true;
          document.getElementById("issueDescription").disabled = true;
          document.getElementById("requestType").disabled = true;
        }
      });
      document.getElementById("ticketCategory").dispatchEvent(new Event("change"));

      // Dynamic Questions for Service Requests.
      document.getElementById("requestType").addEventListener("change", function() {
        const val = this.value;
        const container = document.getElementById("additionalQuestions");
        let html = "";

        if (val === "Access Requests") {
          html = 
            `<div id="accessRequestsSection">
              <div class="mb-3">
                <label for="accessRequestSubtype" class="form-label">
                  Access Subtype
                  <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Option 1: Request for Access to Specific Software Applications – Software/System Name, Access Level, Justification, Duration, and Access Start/End Dates. Option 2: Request to Join Email Distribution List – Distribution List and Reason for Addition. Option 3: Request for VPN/Remote Access – Remote Systems/Resources Name, VPN Access Reason, Duration, and Access Start/End Dates."></i>
                </label>
                <select class="form-control" id="accessRequestSubtype" name="accessRequestSubtype">
                  <option value="">--Select--</option>
                  <option value="Request for Access to Specific Software Applications">Request for Access to Specific Software Applications</option>
                  <option value="Request to Join Email Distribution List">Request to Join Email Distribution List</option>
                  <option value="Request for VPN/Remote Access">Request for VPN/Remote Access</option>
                </select>
              </div>
              <div id="accessSpecificSoftware" class="hidden">
                <div class="mb-3">
                  <label class="form-label">1. Software/System Name <i class="bi bi-info-circle-fill info-icon" title="Enter the software/system name."></i></label>
                  <input type="text" class="form-control" id="softwareName" name="softwareName">
                </div>
                <div class="mb-3">
                  <label class="form-label">2. Access Level <i class="bi bi-info-circle-fill info-icon" title="Select the access level."></i></label>
                  <select class="form-control" id="accessLevel" name="accessLevel">
                    <option value="">--Select--</option>
                    <option value="Read-only">Read-only</option>
                    <option value="Edit">Edit</option>
                    <option value="Admin">Admin</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">3. Justification <i class="bi bi-info-circle-fill info-icon" title="Provide a brief justification."></i></label>
                  <textarea class="form-control" id="accessJustification" name="accessJustification" rows="2"></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">4. Duration (Temporary/Permanent) <i class="bi bi-info-circle-fill info-icon" title="Select the duration."></i></label>
                  <select class="form-control" id="accessDuration" name="accessDuration">
                    <option value="">--Select--</option>
                    <option value="Temporary">Temporary</option>
                    <option value="Permanent">Permanent</option>
                  </select>
                </div>
                <div class="mb-3 hidden" id="accessDatesDiv">
                  <label class="form-label">5. Access Start/End Dates <i class="bi bi-info-circle-fill info-icon" title="If Temporary, choose the start and end dates."></i></label>
                  <div class="row">
                    <div class="col-md-6">
                      <input type="date" class="form-control" id="accessStartDate" name="accessStartDate">
                    </div>
                    <div class="col-md-6">
                      <input type="date" class="form-control" id="accessEndDate" name="accessEndDate">
                    </div>
                  </div>
                </div>
              </div>
              <div id="accessJoinEmail" class="hidden">
                <div class="mb-3">
                  <label class="form-label">1. Distribution List <i class="bi bi-info-circle-fill info-icon" title="Enter the distribution list name."></i></label>
                  <input type="text" class="form-control" id="distributionList" name="distributionList">
                </div>
                <div class="mb-3">
                  <label class="form-label">2. Reason for Addition <i class="bi bi-info-circle-fill info-icon" title="Provide a reason for addition."></i></label>
                  <textarea class="form-control" id="emailJoinReason" name="emailJoinReason" rows="2"></textarea>
                </div>
              </div>
              <div id="accessVPN" class="hidden">
                <div class="mb-3">
                  <label class="form-label">1. Remote Systems/Resources Name <i class="bi bi-info-circle-fill info-icon" title="List the remote systems/resources."></i></label>
                  <input type="text" class="form-control" id="vpnSystems" name="vpnSystems">
                </div>
                <div class="mb-3">
                  <label class="form-label">2. VPN Access Reason <i class="bi bi-info-circle-fill info-icon" title="Explain why VPN access is needed."></i></label>
                  <textarea class="form-control" id="vpnReason" name="vpnReason" rows="2"></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">3. Duration (Temporary/Permanent) <i class="bi bi-info-circle-fill info-icon" title="Select the duration."></i></label>
                  <select class="form-control" id="vpnDuration" name="vpnDuration">
                    <option value="">--Select--</option>
                    <option value="Temporary">Temporary</option>
                    <option value="Permanent">Permanent</option>
                  </select>
                </div>
                <div class="mb-3 hidden" id="vpnDatesDiv">
                  <label class="form-label">4. Access Start/End Dates <i class="bi bi-info-circle-fill info-icon" title="If Temporary, choose the start and end dates."></i></label>
                  <div class="row">
                    <div class="col-md-6">
                      <input type="date" class="form-control" id="vpnStartDate" name="vpnStartDate">
                    </div>
                    <div class="col-md-6">
                      <input type="date" class="form-control" id="vpnEndDate" name="vpnEndDate">
                    </div>
                  </div>
                </div>
              </div>
            </div>`;
        }
        else if (val === "Hardware Requests") {
          const newDeviceSection = 
            `<div id="newDevice" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. Device Type & Quantity <i class="bi bi-info-circle-fill info-icon" title="Enter device type and quantity."></i></label>
                <input type="text" class="form-control" id="deviceNeeded" name="deviceNeeded">
              </div>
              <div class="mb-3">
                <label class="form-label">2. Intended Use <i class="bi bi-info-circle-fill info-icon" title="Describe the intended use."></i></label>
                <textarea class="form-control" id="deviceUsage" name="deviceUsage" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">3. Additional Accessories <i class="bi bi-info-circle-fill info-icon" title="List any additional accessories."></i></label>
                <input type="text" class="form-control" id="accessoriesNeeded" name="accessoriesNeeded">
              </div>
            </div>`;
          const replacementDeviceSection = 
            `<div id="replacementDevice" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. Equipment To Be Replaced <i class="bi bi-info-circle-fill info-icon" title="Enter the equipment to be replaced."></i></label>
                <input type="text" class="form-control" id="equipmentToReplace" name="equipmentToReplace">
              </div>
              <div class="mb-3">
                <label class="form-label">2. Asset Tag/Serial Number <i class="bi bi-info-circle-fill info-icon" title="Enter asset tag/serial number if available."></i></label>
                <input type="text" class="form-control" id="assetTag" name="assetTag">
              </div>
              <div class="mb-3">
                <label class="form-label">3. Issue Description <i class="bi bi-info-circle-fill info-icon" title="Describe the equipment issue."></i></label>
                <textarea class="form-control" id="equipmentIssue" name="equipmentIssue" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">4. Damaged Equipment Available For Return? <i class="bi bi-info-circle-fill info-icon" title="Select Yes if available for return."></i></label>
                <select class="form-control" id="equipmentReturn" name="equipmentReturn">
                  <option value="">--Select--</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>`;
          html = 
            `<div id="hardwareRequestsSection">
              <div class="mb-3">
                <label for="hardwareSubtype" class="form-label">
                  Hardware Subtype
                  <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" title="Option 1: Request for New Computer/Laptop/Device – Device Type & Quantity, Intended Use, and Additional Accessories. Option 2: Request for Replacement of Damaged Equipment – Equipment To Be Replaced, Asset Tag/Serial Number, Issue Description, and Return Availability."></i>
                </label>
                <select class="form-control" id="hardwareSubtype" name="hardwareSubtype">
                  <option value="">--Select--</option>
                  <option value="Request for New Computer/Laptop/Device">Request for New Computer/Laptop/Device</option>
                  <option value="Request for Replacement of Damaged Equipment">Request for Replacement of Damaged Equipment</option>
                </select>
              </div>
              ${newDeviceSection}${replacementDeviceSection}
            </div>`;
        }
        else if (val === "Software Requests") {
          const newSoftwareSection = `
            <div id="newSoftware" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. Software Name <i class="bi bi-info-circle-fill info-icon" title="Enter the full software name."></i></label>
                <input type="text" class="form-control" id="softwareNameNew" name="softwareNameNew">
              </div>
              <div class="mb-3">
                <label class="form-label">2. Justification <i class="bi bi-info-circle-fill info-icon" title="Provide a justification."></i></label>
                <textarea class="form-control" id="softwareReason" name="softwareReason" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">3. License Requirement (Free/Requires License) <i class="bi bi-info-circle-fill info-icon" title="Select the license requirement."></i></label>
                <select class="form-control" id="softwareLicense" name="softwareLicense">
                  <option value="">--Select--</option>
                  <option value="Free">Free</option>
                  <option value="Requires License">Requires License</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">4. Where To Install <i class="bi bi-info-circle-fill info-icon" title="Enter the computer name or asset tag."></i></label>
                <input type="text" class="form-control" id="installationSystem" name="installationSystem">
              </div>
            </div>`;
          const softwareUpgradeSection = `
            <div id="softwareUpgrade" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. Current Version <i class="bi bi-info-circle-fill info-icon" title="Enter your current version."></i></label>
                <input type="text" class="form-control" id="currentVersion" name="currentVersion">
              </div>
              <div class="mb-3">
                <label class="form-label">2. Requested Version <i class="bi bi-info-circle-fill info-icon" title="Enter the requested version."></i></label>
                <input type="text" class="form-control" id="requestedVersion" name="requestedVersion">
              </div>
              <div class="mb-3">
                <label class="form-label">3. Upgrade Justification <i class="bi bi-info-circle-fill info-icon" title="Provide a justification for the upgrade."></i></label>
                <textarea class="form-control" id="upgradeReason" name="upgradeReason" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">4. Deadline (If Applicable) <i class="bi bi-info-circle-fill info-icon" title="Select a deadline if applicable."></i></label>
                <input type="date" class="form-control" id="upgradeDeadline" name="upgradeDeadline">
              </div>
            </div>`;
          html = `
            <div id="softwareRequestsSection">
              <div class="mb-3">
                <label for="softwareSubtype" class="form-label">
                  Software Subtype
                  <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" title="Option 1: Request for New Software Installation – Software Name, Justification, License Requirement, and Where To Install. Option 2: Request for Software Upgrade/Patch – Current Version, Requested Version, Upgrade Justification, and Deadline."></i>
                </label>
                <select class="form-control" id="softwareSubtype" name="softwareSubtype">
                  <option value="">--Select--</option>
                  <option value="Request for New Software Installation">Request for New Software Installation</option>
                  <option value="Request for Software Upgrade/Patch">Request for Software Upgrade/Patch</option>
                </select>
              </div>
              ${newSoftwareSection + softwareUpgradeSection}
            </div>`;
        }
        else if (val === "Network & Security Requests") {
          const unblockWebsite = `
            <div id="unblockWebsite" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. Website/URL To Be Unblocked <i class="bi bi-info-circle-fill info-icon" title="Enter the full website or URL."></i></label>
                <input type="text" class="form-control" id="websiteURL" name="websiteURL">
              </div>
              <div class="mb-3">
                <label class="form-label">2. Access Justification <i class="bi bi-info-circle-fill info-icon" title="Provide a justification for unblocking."></i></label>
                <textarea class="form-control" id="websiteReason" name="websiteReason" rows="2"></textarea>
              </div>
            </div>`;
          const firewallChange = `
            <div id="firewallChange" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. System Identifier (IP/Hostname) <i class="bi bi-info-circle-fill info-icon" title="Enter the IP address or hostname."></i></label>
                <input type="text" class="form-control" id="firewallSystem" name="firewallSystem">
              </div>
              <div class="mb-3">
                <label class="form-label">2. Specific Port/Protocol To Be Opened <i class="bi bi-info-circle-fill info-icon" title="Enter the specific port or protocol."></i></label>
                <input type="text" class="form-control" id="portProtocol" name="portProtocol">
              </div>
              <div class="mb-3">
                <label class="form-label">3. Change Justification <i class="bi bi-info-circle-fill info-icon" title="Explain why the change is needed."></i></label>
                <textarea class="form-control" id="firewallReason" name="firewallReason" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">4. Duration (Temporary/Permanent) <i class="bi bi-info-circle-fill info-icon" title="Select the duration."></i></label>
                <select class="form-control" id="firewallDuration" name="firewallDuration">
                  <option value="">--Select--</option>
                  <option value="Temporary">Temporary</option>
                  <option value="Permanent">Permanent</option>
                </select>
              </div>
              <div class="mb-3 hidden" id="firewallDatesDiv">
                <label class="form-label">5. Access Start/End Dates <i class="bi bi-info-circle-fill info-icon" title="If Temporary, choose the start and end dates."></i></label>
                <div class="row">
                  <div class="col-md-6">
                    <input type="date" class="form-control" id="firewallStartDate" name="firewallStartDate">
                  </div>
                  <div class="col-md-6">
                    <input type="date" class="form-control" id="firewallEndDate" name="firewallEndDate">
                  </div>
                </div>
              </div>
            </div>`;
          html = `
            <div id="networkRequestsSection">
              <div class="mb-3">
                <label for="networkSubtype" class="form-label">
                  Network Subtype
                  <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" title="Option 1: Request to Unblock a Website – Website/URL and Access Justification. Option 2: Request for Firewall Rule Change / Port Opening – System Identifier, Specific Port/Protocol, Change Justification, Duration, and Access Start/End Dates."></i>
                </label>
                <select class="form-control" id="networkSubtype" name="networkSubtype">
                  <option value="">--Select--</option>
                  <option value="Request to Unblock a Website">Request to Unblock a Website</option>
                  <option value="Request for Firewall Rule Change / Port Opening">Request for Firewall Rule Change / Port Opening</option>
                </select>
              </div>
              ${unblockWebsite + firewallChange}
            </div>`;
        }
        else if (val === "User Account Management") {
          const newAccount = `
            <div id="newAccount" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. Employee Full Name <i class="bi bi-info-circle-fill info-icon" title="Enter the employee’s full name."></i></label>
                <input type="text" class="form-control" id="fullName" name="fullName">
              </div>
              <div class="mb-3">
                <label class="form-label">2. Job Title & Department <i class="bi bi-info-circle-fill info-icon" title="Enter your job title and department."></i></label>
                <input type="text" class="form-control" id="jobTitle" name="jobTitle">
              </div>
              <div class="mb-3">
                <label class="form-label">3. Systems/Apps To Access <i class="bi bi-info-circle-fill info-icon" title="List the systems/apps you need access to."></i></label>
                <textarea class="form-control" id="systemsToAccess" name="systemsToAccess" rows="2"></textarea>
              </div>
            </div>`;
          const passwordReset = `
            <div id="passwordReset" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. Username/Full Name <i class="bi bi-info-circle-fill info-icon" title="Enter your username or full name."></i></label>
                <input type="text" class="form-control" id="usernamePR" name="usernamePR">
              </div>
              <div class="mb-3">
                <label class="form-label">2. System/Application For Password Reset <i class="bi bi-info-circle-fill info-icon" title="Specify the system/application."></i></label>
                <input type="text" class="form-control" id="systemPR" name="systemPR">
              </div>
              <div class="mb-3">
                <label class="form-label">3. Confirm Identity With Employee ID <i class="bi bi-info-circle-fill info-icon" title="Enter your employee ID for confirmation."></i></label>
                <input type="text" class="form-control" id="confirmEmployeeId" name="confirmEmployeeId">
              </div>
            </div>`;
          html = `
            <div id="userAccountSection">
              <div class="mb-3">
                <label for="userAccountSubtype" class="form-label">
                  Account Subtype
                  <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" title="Option 1: New Account Creation – Employee Full Name, Job Title & Department, and Systems/Apps. Option 2: Password Reset Request – Username/Full Name, System/Application, and confirm identity with Employee ID."></i>
                </label>
                <select class="form-control" id="userAccountSubtype" name="userAccountSubtype">
                  <option value="">--Select--</option>
                  <option value="New Account Creation">New Account Creation</option>
                  <option value="Password Reset Request">Password Reset Request</option>
                </select>
              </div>
              ${newAccount + passwordReset}
            </div>`;
        }
        else if (val === "Data & Storage Requests") {
          const increaseMailbox = `
            <div id="increaseMailbox" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. Current Mailbox Size (if known) <i class="bi bi-info-circle-fill info-icon" title="Enter your current mailbox size (optional)."></i></label>
                <input type="text" class="form-control" id="currentMailboxSize" name="currentMailboxSize">
              </div>
              <div class="mb-3">
                <label class="form-label">2. Justification For Additional Space <i class="bi bi-info-circle-fill info-icon" title="Explain why additional space is needed."></i></label>
                <textarea class="form-control" id="mailboxReason" name="mailboxReason" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">3. Additional Space Requested <i class="bi bi-info-circle-fill info-icon" title="Specify the extra space required."></i></label>
                <input type="text" class="form-control" id="requestedMailboxSize" name="requestedMailboxSize">
              </div>
            </div>`;
          const networkDriveIncrease = `
            <div id="networkDriveIncrease" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. Network Folder/Drive Name <i class="bi bi-info-circle-fill info-icon" title="Enter the network folder or drive name."></i></label>
                <input type="text" class="form-control" id="networkFolder" name="networkFolder">
              </div>
              <div class="mb-3">
                <label class="form-label">2. Current Allocated Size <i class="bi bi-info-circle-fill info-icon" title="Enter the current allocated size."></i></label>
                <input type="text" class="form-control" id="currentNetworkSize" name="currentNetworkSize">
              </div>
              <div class="mb-3">
                <label class="form-label">3. Additional Space Requested <i class="bi bi-info-circle-fill info-icon" title="Specify the extra space required."></i></label>
                <input type="text" class="form-control" id="requestedNetworkSize" name="requestedNetworkSize">
              </div>
              <div class="mb-3">
                <label class="form-label">4. Justification For Increase <i class="bi bi-info-circle-fill info-icon" title="Provide a justification for the increase."></i></label>
                <textarea class="form-control" id="networkIncreaseReason" name="networkIncreaseReason" rows="2"></textarea>
              </div>
            </div>`;
          const restoreFiles = `
            <div id="restoreFiles" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. File/Email Name Or Description <i class="bi bi-info-circle-fill info-icon" title="Enter the file/email name or description."></i></label>
                <input type="text" class="form-control" id="fileDescription" name="fileDescription">
              </div>
              <div class="mb-3">
                <label class="form-label">2. File/Email Location (e.g., Folder Path) <i class="bi bi-info-circle-fill info-icon" title="Specify the location."></i></label>
                <input type="text" class="form-control" id="fileLocation" name="fileLocation">
              </div>
              <div class="mb-3">
                <label class="form-label">3. Deletion Date <i class="bi bi-info-circle-fill info-icon" title="Select the deletion date."></i></label>  
                <input type="date" class="form-control" id="deletionDate" name="deletionDate">
              </div>
              <div class="mb-3">
                <label class="form-label">4. Recovery Urgency <i class="bi bi-info-circle-fill info-icon" title="Select the urgency level (Critical, Normal, Low)."></i></label>
                <select class="form-control" id="recoveryUrgency" name="recoveryUrgency">
                  <option value="">--Select--</option>
                  <option value="Critical">Critical</option>
                  <option value="Normal">Normal</option>
                  <option value="Low">Low</option>
                </select>
              </div>
            </div>`;
          html = `
            <div id="dataStorageSection">
              <div class="mb-3">
                <label for="dataStorageSubtype" class="form-label">
                  Data Subtype
                  <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" title="Option 1: Request to Increase Mailbox Size – Current Mailbox Size (if known), Justification, and Additional Space Requested. Option 2: Request for Network Drive Storage Increase – Network Folder/Drive Name, Current Allocated Size, Additional Space Requested, and Justification. Option 3: Request to Restore Deleted Files or Emails – File/Email Name/Description, Location, Deletion Date, and Recovery Urgency."></i>
                </label>
                <select class="form-control" id="dataStorageSubtype" name="dataStorageSubtype">
                  <option value="">--Select--</option>
                  <option value="Request to Increase Mailbox Size">Request to Increase Mailbox Size</option>
                  <option value="Request for Network Drive Storage Increase">Request for Network Drive Storage Increase</option>
                  <option value="Request to Restore Deleted Files or Emails">Request to Restore Deleted Files or Emails</option>
                </select>
              </div>
              ${increaseMailbox + networkDriveIncrease + restoreFiles}
            </div>`;
        }
        else if (val === "Telephony/Communication Requests") {
          const newTelephone = `
            <div id="newTelephone" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. Request Justification <i class="bi bi-info-circle-fill info-icon" title="Explain why a new telephone is required."></i></label>
                <textarea class="form-control" id="newTelephoneReason" name="newTelephoneReason" rows="2"></textarea>
              </div>
            </div>`;
          const changeExtension = `
            <div id="changeExtension" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. Current Extension Number <i class="bi bi-info-circle-fill info-icon" title="Enter your current extension number."></i></label>
                <input type="text" class="form-control" id="currentExtension" name="currentExtension">
              </div>
              <div class="mb-3">
                <label class="form-label">2. Proposed New Extension Number <i class="bi bi-info-circle-fill info-icon" title="Enter your desired new extension number."></i></label>
                <input type="text" class="form-control" id="newExtension" name="newExtension">
              </div>
            </div>`;
          html = `
            <div id="telephonySection">
              <div class="mb-3">
                <label for="telephonySubtype" class="form-label">
                  Telephony Subtype
                  <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" title="Option 1: Request for New Telephone – Provide request justification. Option 2: Change of Telephone extension number – Provide current and proposed extension numbers."></i>
                </label>
                <select class="form-control" id="telephonySubtype" name="telephonySubtype">
                  <option value="">--Select--</option>
                  <option value="Request for New Telephone">Request for New Telephone</option>
                  <option value="Change of Telephone extension number">Change of Telephone extension number</option>
                </select>
              </div>
              ${newTelephone + changeExtension}
            </div>`;
        }
        else if (val === "Maintenance & Scheduled Tasks") {
          const plannedDowntime = `
            <div id="plannedDowntime" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. System/Application Requiring Downtime <i class="bi bi-info-circle-fill info-icon" title="Enter the system or application."></i></label>
                <input type="text" class="form-control" id="downtimeSystem" name="downtimeSystem">
              </div>
              <div class="mb-3">
                <label class="form-label">2. Downtime Justification <i class="bi bi-info-circle-fill info-icon" title="Provide a justification."></i></label>
                <textarea class="form-control" id="downtimeReason" name="downtimeReason" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">3. Proposed Downtime Date/Time <i class="bi bi-info-circle-fill info-icon" title="Select the proposed start date/time."></i></label>
                <input type="datetime-local" class="form-control" id="downtimeDateTime" name="downtimeDateTime">
              </div>
              <div class="mb-3">
                <label class="form-label">4. Estimated Duration <i class="bi bi-info-circle-fill info-icon" title="Enter the estimated duration (e.g., 2 hours)."></i></label>
                <input type="text" class="form-control" id="downtimeDuration" name="downtimeDuration" placeholder="e.g., 2 hours">
              </div>
            </div>`;
          const backupRestore = `
            <div id="backupRestore" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. Data/System To Be Backed Up/Restored <i class="bi bi-info-circle-fill info-icon" title="Enter the data or system name."></i></label>
                <input type="text" class="form-control" id="backupSystem" name="backupSystem">
              </div>
              <div class="mb-3">
                <label class="form-label">2. Backup Date (If Applicable) <i class="bi bi-info-circle-fill info-icon" title="Select the backup date if applicable."></i></label>
                <input type="date" class="form-control" id="backupDate" name="backupDate">
              </div>
              <div class="mb-3">
                <label class="form-label">3. Restore Justification <i class="bi bi-info-circle-fill info-icon" title="Provide a justification for the restore request."></i></label>
                <textarea class="form-control" id="backupReason" name="backupReason" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">4. Emergency Restore <i class="bi bi-info-circle-fill info-icon" title="Select Yes if this is an emergency restore."></i></label>
                <select class="form-control" id="emergencyRestore" name="emergencyRestore">
                  <option value="">--Select--</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>`;
          html = `
            <div id="maintenanceSection">
              <div class="mb-3">
                <label for="maintenanceSubtype" class="form-label">
                  Maintenance Subtype
                  <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" title="Option 1: Request for Planned Downtime Notification – System/Application, Downtime Justification, Proposed Date/Time, and Estimated Duration. Option 2: Backup or Restore Request – Data/System, Backup Date, Restore Justification, and Emergency Restore."></i>
                </label>
                <select class="form-control" id="maintenanceSubtype" name="maintenanceSubtype">
                  <option value="">--Select--</option>
                  <option value="Request for Planned Downtime Notification">Request for Planned Downtime Notification</option>
                  <option value="Backup or Restore Request">Backup or Restore Request</option>
                </select>
              </div>
              ${plannedDowntime + backupRestore}
            </div>`;
        }
        else if (val === "IT Consultation & Advisory") {
          html = `
            <div id="consultationSection">
              <div class="mb-3">
                <label for="consultationSubtype" class="form-label">
                  Consultation Subtype
                  <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" title="Only one option: Request for IT Consultation."></i>
                </label>
                <select class="form-control" id="consultationSubtype" name="consultationSubtype">
                  <option value="">--Select--</option>
                  <option value="Request for IT Consultation">Request for IT Consultation</option>
                </select>
              </div>
              <div id="itConsultationQuestions" class="hidden">
                <div class="mb-3">
                  <label class="form-label">1. Project/Requirement Description <i class="bi bi-info-circle-fill info-icon" title="Provide a detailed description of your project/requirement."></i></label>
                  <textarea class="form-control" id="consultationDescription" name="consultationDescription" rows="2"></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">2. IT Assistance Expectation <i class="bi bi-info-circle-fill info-icon" title="Describe the IT assistance you expect."></i></label>
                  <textarea class="form-control" id="consultationAssistance" name="consultationAssistance" rows="2"></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">3. Project Start Date <i class="bi bi-info-circle-fill info-icon" title="Select the project start date."></i></label>
                  <input type="date" class="form-control" id="consultationStartDate" name="consultationStartDate">
                </div>
              </div>
            </div>`;
        }
        else if (val === "Workstation Setup & Transfer Requests") {
          const newWorkstation = `
            <div id="newWorkstation" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. Office Location <i class="bi bi-info-circle-fill info-icon" title="Enter the office location for the new workstation."></i></label>
                <input type="text" class="form-control" id="workstationOfficeLocation" name="workstationOfficeLocation">
              </div>
              <div class="mb-3">
                <label class="form-label">2. Completion Date For Setup <i class="bi bi-info-circle-fill info-icon" title="Select the completion date for setup."></i></label>
                <input type="date" class="form-control" id="workstationCompletionDate" name="workstationCompletionDate">
              </div>
              <div class="mb-3">
                <label class="form-label">3. Equipment To Be Moved (Include Asset Tag Numbers & Quantity) <i class="bi bi-info-circle-fill info-icon" title="List the equipment to be moved."></i></label>
                <textarea class="form-control" id="equipmentList" name="equipmentList" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">4. Special Setup Instructions <i class="bi bi-info-circle-fill info-icon" title="Provide any special setup instructions."></i></label>
                <textarea class="form-control" id="workstationInstructions" name="workstationInstructions" rows="2"></textarea>
              </div>
            </div>`;
          const workstationTransfer = `
            <div id="workstationTransfer" class="hidden">
              <div class="mb-3">
                <label class="form-label">1. Current Office Location <i class="bi bi-info-circle-fill info-icon" title="Enter your current office location."></i></label>
                <input type="text" class="form-control" id="currentOfficeLocation" name="currentOfficeLocation">
              </div>
              <div class="mb-3">
                <label class="form-label">2. New Office Location <i class="bi bi-info-circle-fill info-icon" title="Enter the new office location."></i></label>
                <input type="text" class="form-control" id="newOfficeLocation" name="newOfficeLocation">
              </div>
              <div class="mb-3">
                <label class="form-label">3. Preferred Move Date/Time <i class="bi bi-info-circle-fill info-icon" title="Select the preferred move date and time."></i></label>
                <input type="datetime-local" class="form-control" id="moveDateTime" name="moveDateTime">
              </div>
              <div class="mb-3">
                <label class="form-label">4. Completion Date For Relocation <i class="bi bi-info-circle-fill info-icon" title="Select the completion date for relocation."></i></label>
                <input type="date" class="form-control" id="transferCompletionDate" name="transferCompletionDate">
              </div>
              <div class="mb-3">
                <label class="form-label">5. Move Duration (Permanent/Temporary) <i class="bi bi-info-circle-fill info-icon" title="Select if the move is Permanent or Temporary."></i></label>
                <select class="form-control" id="moveType" name="moveType">
                  <option value="">--Select--</option>
                  <option value="Permanent">Permanent</option>
                  <option value="Temporary">Temporary</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">6. Equipment To Be Moved (Include Asset Tag Numbers & Quantity) <i class="bi bi-info-circle-fill info-icon" title="List the equipment to be moved."></i></label>
                <textarea class="form-control" id="transferEquipmentList" name="transferEquipmentList" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">7. Phone Extension Transfer <i class="bi bi-info-circle-fill info-icon" title="Select Yes if your phone extension needs to be transferred."></i></label>
                <select class="form-control" id="phoneExtensionTransfer" name="phoneExtensionTransfer">
                  <option value="">--Select--</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">8. Special Setup Instructions <i class="bi bi-info-circle-fill info-icon" title="Provide any additional special instructions."></i></label>
                <input type="text" class="form-control" id="transferFloorPlan" name="transferFloorPlan" placeholder="URL or description">
              </div>
            </div>`;
          html = `
            <div id="workstationSection">
              <div class="mb-3">
                <label for="workstationSubtype" class="form-label">
                  Workstation Subtype
                  <i class="bi bi-info-circle-fill info-icon" data-bs-toggle="tooltip" title="Option 1: New Workstation Setup Request – Office Location, Completion Date, Equipment details, and Special Setup Instructions. Option 2: Workstation Transfer / Relocation Request – Current Office, New Office, Preferred Move Date/Time, Completion Date, Move Duration, Equipment details, Phone Extension Transfer, and Special Instructions."></i>
                </label>
                <select class="form-control" id="workstationSubtype" name="workstationSubtype">
                  <option value="">--Select--</option>
                  <option value="New Workstation Setup Request">New Workstation Setup Request</option>
                  <option value="Workstation Transfer / Relocation Request">Workstation Transfer / Relocation Request</option>
                </select>
              </div>
              ${newWorkstation + workstationTransfer}
            </div>`;
        }
        container.innerHTML = html;

        // Reinitialize tooltips.
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));

        // Attach dynamic event listeners for newly injected fields...
        const accessDuration = document.getElementById("accessDuration");
        if (accessDuration) {
          accessDuration.addEventListener("change", function() {
            if (this.value === "Temporary") {
              document.getElementById("accessDatesDiv").classList.remove("hidden");
            } else {
              document.getElementById("accessDatesDiv").classList.add("hidden");
            }
          });
        }
        const vpnDuration = document.getElementById("vpnDuration");
        if (vpnDuration) {
          vpnDuration.addEventListener("change", function() {
            if (this.value === "Temporary") {
              document.getElementById("vpnDatesDiv").classList.remove("hidden");
            } else {
              document.getElementById("vpnDatesDiv").classList.add("hidden");
            }
          });
        }
        const firewallDuration = document.getElementById("firewallDuration");
        if (firewallDuration) {
          firewallDuration.addEventListener("change", function() {
            if (this.value === "Temporary") {
              document.getElementById("firewallDatesDiv").classList.remove("hidden");
            } else {
              document.getElementById("firewallDatesDiv").classList.add("hidden");
            }
          });
        }
        const consultationSubtype = document.getElementById("consultationSubtype");
        if (consultationSubtype) {
          consultationSubtype.addEventListener("change", function() {
            if (this.value === "Request for IT Consultation") {
              document.getElementById("itConsultationQuestions").classList.remove("hidden");
            } else {
              document.getElementById("itConsultationQuestions").classList.add("hidden");
            }
          });
        }
        const accessRequestSubtype = document.getElementById("accessRequestSubtype");
        if (accessRequestSubtype) {
          accessRequestSubtype.addEventListener("change", function() {
            document.getElementById("accessSpecificSoftware").classList.add("hidden");
            document.getElementById("accessJoinEmail").classList.add("hidden");
            document.getElementById("accessVPN").classList.add("hidden");
            if (this.value === "Request for Access to Specific Software Applications") {
              document.getElementById("accessSpecificSoftware").classList.remove("hidden");
            } else if (this.value === "Request to Join Email Distribution List") {
              document.getElementById("accessJoinEmail").classList.remove("hidden");
            } else if (this.value === "Request for VPN/Remote Access") {
              document.getElementById("accessVPN").classList.remove("hidden");
            }
          });
        }
        const hardwareSubtype = document.getElementById("hardwareSubtype");
        if (hardwareSubtype) {
          hardwareSubtype.addEventListener("change", function() {
            const newDeviceSection = document.getElementById("newDevice");
            const replacementDeviceSection = document.getElementById("replacementDevice");
            [newDeviceSection, replacementDeviceSection].forEach(section => {
              section.classList.add("hidden");
              section.querySelectorAll("input, select, textarea").forEach(field => {
                field.disabled = true;
              });
            });
            if (this.value === "Request for New Computer/Laptop/Device") {
              newDeviceSection.classList.remove("hidden");
              newDeviceSection.querySelectorAll("input, select, textarea").forEach(field => {
                field.disabled = false;
              });
            } else if (this.value === "Request for Replacement of Damaged Equipment") {
              replacementDeviceSection.classList.remove("hidden");
              replacementDeviceSection.querySelectorAll("input, select, textarea").forEach(field => {
                field.disabled = false;
              });
            }
          });
        }
        const softwareSubtype = document.getElementById("softwareSubtype");
        if (softwareSubtype) {
          softwareSubtype.addEventListener("change", function() {
            const newSoftwareSection = document.getElementById("newSoftware");
            const softwareUpgradeSection = document.getElementById("softwareUpgrade");
            [newSoftwareSection, softwareUpgradeSection].forEach(section => {
              section.classList.add("hidden");
              section.querySelectorAll("input, select, textarea").forEach(field => {
                field.disabled = true;
              });
            });
            if (this.value === "Request for New Software Installation") {
              newSoftwareSection.classList.remove("hidden");
              newSoftwareSection.querySelectorAll("input, select, textarea").forEach(field => {
                field.disabled = false;
              });
            } else if (this.value === "Request for Software Upgrade/Patch") {
              softwareUpgradeSection.classList.remove("hidden");
              softwareUpgradeSection.querySelectorAll("input, select, textarea").forEach(field => {
                field.disabled = false;
              });
            }
          });
        }
        const networkSubtype = document.getElementById("networkSubtype");
        if (networkSubtype) {
          networkSubtype.addEventListener("change", function() {
            document.getElementById("unblockWebsite").classList.add("hidden");
            document.getElementById("firewallChange").classList.add("hidden");
            if (this.value === "Request to Unblock a Website") {
              document.getElementById("unblockWebsite").classList.remove("hidden");
            } else if (this.value === "Request for Firewall Rule Change / Port Opening") {
              document.getElementById("firewallChange").classList.remove("hidden");
            }
          });
        }
        const userAccountSubtype = document.getElementById("userAccountSubtype");
        if (userAccountSubtype) {
          userAccountSubtype.addEventListener("change", function() {
            document.getElementById("newAccount").classList.add("hidden");
            document.getElementById("passwordReset").classList.add("hidden");
            if (this.value === "New Account Creation") {
              document.getElementById("newAccount").classList.remove("hidden");
            } else if (this.value === "Password Reset Request") {
              document.getElementById("passwordReset").classList.remove("hidden");
            }
          });
        }
        const dataStorageSubtype = document.getElementById("dataStorageSubtype");
        if (dataStorageSubtype) {
          dataStorageSubtype.addEventListener("change", function() {
            document.getElementById("increaseMailbox").classList.add("hidden");
            document.getElementById("networkDriveIncrease").classList.add("hidden");
            document.getElementById("restoreFiles").classList.add("hidden");
            if (this.value === "Request to Increase Mailbox Size") {
              document.getElementById("increaseMailbox").classList.remove("hidden");
            } else if (this.value === "Request for Network Drive Storage Increase") {
              document.getElementById("networkDriveIncrease").classList.remove("hidden");
            } else if (this.value === "Request to Restore Deleted Files or Emails") {
              document.getElementById("restoreFiles").classList.remove("hidden");
            }
          });
        }
        const telephonySubtype = document.getElementById("telephonySubtype");
        if (telephonySubtype) {
          telephonySubtype.addEventListener("change", function() {
            document.getElementById("newTelephone").classList.add("hidden");
            document.getElementById("changeExtension").classList.add("hidden");
            if (this.value === "Request for New Telephone") {
              document.getElementById("newTelephone").classList.remove("hidden");
            } else if (this.value === "Change of Telephone extension number") {
              document.getElementById("changeExtension").classList.remove("hidden");
            }
          });
        }
        const maintenanceSubtype = document.getElementById("maintenanceSubtype");
        if (maintenanceSubtype) {
          maintenanceSubtype.addEventListener("change", function() {
            document.getElementById("plannedDowntime").classList.add("hidden");
            document.getElementById("backupRestore").classList.add("hidden");
            if (this.value === "Request for Planned Downtime Notification") {
              document.getElementById("plannedDowntime").classList.remove("hidden");
            } else if (this.value === "Backup or Restore Request") {
              document.getElementById("backupRestore").classList.remove("hidden");
            }
          });
        }
        const workstationSubtype = document.getElementById("workstationSubtype");
        if (workstationSubtype) {
          workstationSubtype.addEventListener("change", function() {
            document.getElementById("newWorkstation").classList.add("hidden");
            document.getElementById("workstationTransfer").classList.add("hidden");
            if (this.value === "New Workstation Setup Request") {
              document.getElementById("newWorkstation").classList.remove("hidden");
            } else if (this.value === "Workstation Transfer / Relocation Request") {
              document.getElementById("workstationTransfer").classList.remove("hidden");
            }
          });
        }
      });

      // Form Submission with loading indicator.
      document.getElementById("ticketForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const submitBtn = document.getElementById("submitButton");
        const submitSpinner = document.getElementById("submitSpinner");
        const submitBtnText = document.getElementById("submitButtonText");

        submitBtn.disabled = true;
        submitBtnText.textContent = "Submitting...";
        submitSpinner.classList.remove("hidden");

        const formData = {
          employeeId:     document.getElementById("employeeId").value,
          employeeName: document.getElementById("employeeName").value,
          lineOfBusiness: document.getElementById("lineOfBusiness").value,
          officeSite: document.getElementById("officeSite").value,
          email: document.getElementById("email").value,
          priorityLevel: document.getElementById("priorityLevel").value,
          ticketCategory: document.getElementById("ticketCategory").value,
          detailedLocation: document.getElementById("detailedLocation") ? document.getElementById("detailedLocation").value : "",
          issueClassification: document.getElementById("issueClassification") ? document.getElementById("issueClassification").value : "",
          issueDescription: document.getElementById("issueDescription") ? document.getElementById("issueDescription").value : "",
          requestType: document.getElementById("requestType") ? document.getElementById("requestType").value : "",
          remarks: document.getElementById("remarks").value
        };

        if (formData.ticketCategory === "Service Request") {
          const additionalQuestionsContainer = document.getElementById("additionalQuestions");
          let additionalData = {};
          if (additionalQuestionsContainer) {
            const inputs = additionalQuestionsContainer.querySelectorAll("input, select, textarea");
            inputs.forEach(input => {
              if (input.name) {
                additionalData[input.name] = input.value;
              }
            });
          }
          formData.additionalDetails = JSON.stringify(additionalData);
        }

        var fileInput = document.getElementById("attachment");
        if (fileInput.files.length > 0) {
          // ─── validate every selected file ───────────────────────────────
          const docTypes = [
            'application/pdf',
            'application/msword',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/vnd.ms-excel',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'application/vnd.ms-powerpoint',
            'application/vnd.openxmlformats-officedocument.presentationml.presentation'
          ];
          for (let i = 0; i < fileInput.files.length; i++) {
            const file = fileInput.files[i];
            if (
              !file.type.startsWith('image/') &&
              docTypes.indexOf(file.type) < 0
            ) {
              showError(`Invalid file type: ${file.name}`);
              submitSpinner.classList.add("hidden");
              submitBtn.disabled = false;
              submitBtnText.textContent = "Submit Ticket";
              return;
            }
          }
          // ─── now safe to read & encode ──────────────────────────────────
          let filesArray = [];
          let filesProcessed = 0;
          for (let i = 0; i < fileInput.files.length; i++) {
            let file = fileInput.files[i];
            let reader = new FileReader();
            reader.onload = function(e) {
              let base64data = e.target.result.split(",")[1];
              filesArray.push({ name: file.name, type: file.type, data: base64data });
              filesProcessed++;
              if (filesProcessed === fileInput.files.length) {
                formData.attachments = JSON.stringify(filesArray);
                submitTicket(formData);
              }
            };
            reader.readAsDataURL(file);
          }
        }

        function submitTicket(formData) {
          if (!formData.employeeName || !formData.lineOfBusiness) {
            showError("Please verify a valid employee ID before submitting.");
            submitSpinner.classList.add("hidden");
            submitBtn.disabled = false;
            submitBtnText.textContent = "Submit Ticket";
            return;
          }
          google.script.run
            .withSuccessHandler(function(ticketNumber) {
              document.getElementById("ticketModalBody").textContent =
                "Your ticket has been submitted. Your Ticket Number is: " + ticketNumber;
              const ticketModal = new bootstrap.Modal(document.getElementById("ticketModal"));
              ticketModal.show();
              document.getElementById("ticketForm").reset();
              document.getElementById("incidentFields").classList.add("hidden");
              document.getElementById("serviceFields").classList.add("hidden");
              submitSpinner.classList.add("hidden");
              submitBtn.disabled = false;
              submitBtnText.textContent = "Submit Ticket";
            })
            .withFailureHandler(function(error) {
              showError("Error submitting ticket: " + (error.message || error));
              submitSpinner.classList.add("hidden");
              submitBtn.disabled = false;
              submitBtnText.textContent = "Submit Ticket";
            })
            .createTicket(formData);
        }
      });

      function showError(msg) {
        document.getElementById("errorModalBody").innerHTML = msg;
        const errorModal = new bootstrap.Modal(document.getElementById("errorModal"));
        errorModal.show();
      }

    </script>
  </body>
</html>
